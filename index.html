<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Preschool Check-In/Out</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase compat (single-file HTML) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <style>
    .bg-grid{background-image:radial-gradient(circle at 1px 1px, rgba(255,255,255,0.12) 1px, transparent 0);background-size:18px 18px}
    select option{color:#0f172a;background:#fff}
    ::-webkit-scrollbar{height:10px;width:10px}
    ::-webkit-scrollbar-thumb{background:rgba(100,116,139,0.35);border-radius:999px}
    ::-webkit-scrollbar-track{background:rgba(241,245,249,0)}
  </style>

  <script>
    tailwind.config = { theme:{ extend:{ boxShadow:{ card:"0 18px 60px rgba(2,6,23,0.20)" } } } };
  </script>
</head>

<body class="min-h-screen text-slate-900">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-indigo-950 to-slate-900"></div>
    <div class="absolute inset-0 opacity-30 bg-grid"></div>
    <div class="absolute -top-28 -left-28 w-[520px] h-[520px] rounded-full blur-3xl opacity-25 bg-gradient-to-br from-cyan-300 via-indigo-400 to-fuchsia-400"></div>
    <div class="absolute -bottom-40 -right-28 w-[620px] h-[620px] rounded-full blur-3xl opacity-20 bg-gradient-to-br from-amber-300 via-rose-300 to-indigo-300"></div>
    <div class="absolute top-[30%] left-[55%] w-[380px] h-[380px] rounded-full blur-3xl opacity-15 bg-gradient-to-br from-emerald-300 via-cyan-300 to-indigo-300"></div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-20">
    <div class="backdrop-blur-xl bg-white/10 border-b border-white/10">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-white/15 border border-white/15 flex items-center justify-center shadow-card">
            <span class="text-white text-lg">üß∏</span>
          </div>
          <div>
            <h1 class="text-white text-lg md:text-xl font-semibold tracking-tight">Check-In / Out</h1>
            <p class="text-white/70 text-xs md:text-sm" id="subTitle">Welcome</p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <span id="schoolBadge" class="hidden sm:inline text-xs px-3 py-1 rounded-full bg-white/10 border border-white/15 text-white/90"></span>

          <button id="mySchoolsBtn" class="hidden px-3 py-1 rounded-xl text-xs font-semibold bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
            My Schools
          </button>

          <button id="switchSchoolBtn" class="hidden px-3 py-1 rounded-xl text-xs font-semibold bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
            Switch School
          </button>

          <button id="logoutBtn" class="hidden px-4 py-2 rounded-xl text-sm font-semibold bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
            Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 lg:py-10">
    <!-- Offline -->
    <div id="offlineBar" class="hidden mb-4 rounded-2xl border border-amber-200/20 bg-amber-400/10 px-4 py-3 text-sm text-amber-50">
      Offline / blocked network. Use a hosted URL (not file://) and check internet.
    </div>

    <!-- Status -->
    <div id="statusWrap" class="hidden mb-5">
      <div id="statusMsg" class="rounded-2xl border px-4 py-3 text-sm"></div>
    </div>

    <!-- AUTH -->
    <section id="authShell" class="space-y-6">
      <!-- Role picker -->
      <section id="rolePickView">
        <div class="max-w-xl mx-auto rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card p-6">
          <h2 class="text-white font-semibold text-lg">Continue as</h2>
          <div class="mt-4 grid grid-cols-2 gap-3">
            <button id="pickStaffBtn" class="px-4 py-4 rounded-2xl bg-white text-slate-900 font-semibold hover:bg-slate-100 transition">
              üë©‚Äçüè´ Staff
            </button>
            <button id="pickParentBtn" class="px-4 py-4 rounded-2xl bg-indigo-500 text-white font-semibold hover:bg-indigo-600 transition">
              üë®‚Äçüë©‚Äçüëß Parent
            </button>
          </div>

          <div class="mt-5 text-white/70 text-sm">
            Each school uses a unique code for access. Ask your school administrator if unsure.
          </div>
        </div>
      </section>

      <section class="grid lg:grid-cols-2 gap-6">
        <!-- Staff Auth -->
        <div id="staffAuthCard" class="hidden rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card">
          <div class="p-6">
            <div class="flex items-center justify-between">
              <h2 class="text-white font-semibold text-lg">Staff</h2>
              <span class="text-xs px-3 py-1 rounded-full bg-cyan-400/10 border border-cyan-200/20 text-cyan-50">Email Link OR Password</span>
            </div>

            <div class="mt-4 space-y-3">
              <input id="staffSchoolCode" autocomplete="off" list="schoolCodesList"
                class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-300/40"
                placeholder="School code"/>

              <datalist id="schoolCodesList"></datalist>

              <div id="recentSchoolsSection" class="hidden">
                <div class="text-white/70 text-xs mb-2 flex items-center gap-2">
                  <span>Recent Schools</span><span class="text-white/50">‚Ä¢</span>
                  <span class="text-white/50 text-xs">Click to select</span>
                </div>
                <div id="recentSchoolsList" class="flex flex-wrap gap-2"></div>
              </div>

              <input id="staffEmail" type="email" autocomplete="username"
                class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-300/40"
                placeholder="Email"/>

              <!-- Password login (optional) -->
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="text-white/80 text-xs font-semibold mb-3">Option A: Email + Password</div>
                <input id="staffPassword" type="password" autocomplete="current-password"
                  class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-300/40"
                  placeholder="Password"/>

                <div class="mt-3 grid grid-cols-2 gap-3">
                  <button id="staffLoginBtn" class="px-4 py-3 rounded-2xl bg-white text-slate-900 font-semibold hover:bg-slate-100 transition">
                    Login
                  </button>
                  <button id="staffCreateBtn" class="px-4 py-3 rounded-2xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                    Create account
                  </button>
                </div>

                <div class="mt-2 text-center">
                  <button id="forgotPasswordBtn" class="text-white/70 hover:text-white text-sm underline transition">
                    Forgot password?
                  </button>
                </div>
              </div>

              <!-- Email link login (recommended) -->
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="text-white/80 text-xs font-semibold mb-2">Option B (Recommended): Passwordless Email Link</div>
                <button id="sendStaffEmailLinkBtn" class="w-full px-4 py-3 rounded-2xl bg-cyan-500 text-white font-semibold hover:bg-cyan-600 transition">
                  Send staff login link
                </button>
                <div class="text-white/60 text-xs mt-2">
                  Works even if they were only invited (no password needed). Check spam/promotions.
                </div>
              </div>

              <div class="text-white/60 text-xs">
                First staff to sign in to a new school code automatically becomes <b>Owner</b>.
              </div>

              <button id="backToRole1" class="w-full px-4 py-3 rounded-2xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                ‚Üê Back
              </button>
            </div>
          </div>
        </div>

        <!-- Parent Auth -->
        <div id="parentAuthCard" class="hidden rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card">
          <div class="p-6">
            <div class="flex items-center justify-between">
              <h2 class="text-white font-semibold text-lg">Parent</h2>
              <span class="text-xs px-3 py-1 rounded-full bg-indigo-400/10 border border-indigo-200/20 text-indigo-50">Passwordless Email Link</span>
            </div>

            <div class="mt-4 space-y-3">
              <input id="parentSchoolCode" autocomplete="off"
                class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-300/40"
                placeholder="School code"/>

              <input id="parentEmail" type="email" autocomplete="email"
                class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-300/40"
                placeholder="Email"/>

              <button id="sendEmailLinkBtn" class="w-full px-4 py-3 rounded-2xl bg-indigo-500 text-white font-semibold hover:bg-indigo-600 transition">
                Send login link
              </button>

              <div class="text-white/60 text-xs">
                We‚Äôll email a secure sign-in link. Check Spam/Promotions if you don‚Äôt see it.
              </div>

              <button id="backToRole2" class="w-full px-4 py-3 rounded-2xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                ‚Üê Back
              </button>
            </div>
          </div>
        </div>

        <div id="emailLinkHint" class="hidden lg:col-span-2 rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card">
          <div class="p-6 text-white/85 text-sm">
            If you opened the sign-in link on a different device, you may be prompted to confirm your email.
          </div>
        </div>
      </section>
    </section>

    <!-- PARENT VIEW -->
    <section id="parentView" class="hidden space-y-6">
      <div class="rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card">
        <div class="p-6 md:p-7">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h2 class="text-white font-semibold text-lg">Parent</h2>
              <p id="parentHeaderInfo" class="text-white/70 text-sm"></p>
            </div>
            <div class="text-white/70 text-sm">
              <span id="parentIdentityText" class="text-white font-semibold"></span>
            </div>
          </div>

          <div class="mt-5 grid lg:grid-cols-2 gap-4">
            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="flex items-center justify-between">
                <div class="text-white/85 text-sm font-semibold">Children</div>
                <span class="text-xs px-3 py-1 rounded-full bg-white/10 border border-white/15 text-white/80">Select</span>
              </div>
              <div id="parentKidsList" class="mt-3 max-h-[360px] overflow-auto rounded-2xl border border-white/10 bg-white/5"></div>
            </div>

            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="text-white/85 text-sm font-semibold">Request</div>

              <div class="mt-4">
                <div id="pSelectedChild" class="text-white text-lg font-semibold">Select a child</div>
                <div id="pSelectedStatus" class="text-white/60 text-xs mt-1"></div>
              </div>

              <div class="mt-4">
                <input id="pNotes"
                  class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-300/40"
                  placeholder="Note (optional)"/>
              </div>

              <div class="mt-5 grid grid-cols-2 gap-3">
                <button id="dropOffReqBtn" class="px-4 py-4 rounded-2xl bg-emerald-500 text-white font-semibold hover:bg-emerald-600 active:scale-[0.99] transition">
                  ‚úÖ Drop-off
                </button>
                <button id="pickUpReqBtn" class="px-4 py-4 rounded-2xl bg-indigo-500 text-white font-semibold hover:bg-indigo-600 active:scale-[0.99] transition">
                  üéí Pick-up
                </button>
              </div>

              <button id="clearParentSelectionBtn" class="mt-3 w-full px-4 py-3 rounded-2xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                Clear
              </button>

              <div class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="text-white/70 text-xs">Pending</div>
                <div id="parentPendingList" class="mt-2 text-white/85 text-sm"></div>
              </div>

              <div class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="text-white/70 text-xs">Announcements</div>
                <div id="parentAnnouncementsList" class="mt-2 text-white/85 text-sm"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- STAFF VIEW -->
    <section id="staffView" class="hidden space-y-6">
      <div class="rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card">
        <div class="p-6 md:p-7">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h2 class="text-white font-semibold text-lg">Staff</h2>
              <p class="text-white/70 text-sm">Approve ‚Ä¢ Export ‚Ä¢ Archive</p>
              <p id="staffRoleLine" class="text-white/60 text-xs mt-1"></p>
            </div>

            <div class="flex flex-wrap gap-2">
              <button id="sendAnnouncementBtn" class="px-4 py-2 rounded-xl bg-purple-500 text-white font-semibold hover:bg-purple-600 transition">
                üì¢ Send Announcement
              </button>
              <button id="exportPdfBtn" class="px-4 py-2 rounded-xl bg-amber-500 text-white font-semibold hover:bg-amber-600 transition">
                Export PDF & Clear
              </button>
              <button id="exportCsvBtn" class="px-4 py-2 rounded-xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                Export CSV & Clear
              </button>
              <button id="clearTodayBtn" class="px-4 py-2 rounded-xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                Clear today
              </button>
            </div>
          </div>

          <!-- Owner-only: Staff Management -->
          <div id="ownerPanel" class="hidden mt-6 rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center justify-between">
              <div class="text-white/85 text-sm font-semibold">Owner: Staff Management</div>
              <span class="text-xs px-3 py-1 rounded-full bg-fuchsia-400/10 border border-fuchsia-200/20 text-fuchsia-50">Owner only</span>
            </div>

            <div class="mt-4 space-y-3">
              <input id="inviteStaffName" class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-fuchsia-300/40" placeholder="Staff name"/>
              <div class="grid md:grid-cols-3 gap-3">
                <input id="inviteStaffEmail" class="rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-fuchsia-300/40" placeholder="Staff email"/>
                <select id="inviteStaffRole" class="rounded-2xl border border-white/15 bg-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-fuchsia-300/40">
                  <option value="staff">Staff</option>
                  <option value="owner">Owner (use carefully)</option>
                </select>
                <button id="inviteBtn" class="px-4 py-3 rounded-2xl bg-fuchsia-500 text-white font-semibold hover:bg-fuchsia-600 transition">
                  Invite / Add by Email
                </button>
              </div>
            </div>

            <div class="mt-3 text-white/60 text-xs">
              Enter email ‚Üí app creates an invite. Staff can sign in using <b>Staff Email Link</b> or Email+Password, then invite is auto-accepted.
            </div>

            <div class="mt-4 rounded-2xl border border-white/10 bg-white/5">
              <div class="p-3 border-b border-white/10 text-white/85 text-sm font-semibold">Current staff</div>
              <div id="staffList" class="max-h-[260px] overflow-auto"></div>
            </div>
          </div>

          <div class="mt-6 grid lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="text-white/85 text-sm font-semibold">Header</div>
              <div class="mt-3 space-y-3">
                <input id="schoolName" class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-300/40" placeholder="School name"/>
                <input id="className" class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-300/40" placeholder="Classroom"/>
                <input id="staffName" class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-300/40" placeholder="Staff on duty"/>

                <button id="saveSessionBtn" class="w-full px-4 py-3 rounded-2xl bg-white text-slate-900 font-semibold hover:bg-slate-100 transition">
                  Save
                </button>
              </div>
            </div>

            <div class="lg:col-span-4 rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="text-white/85 text-sm font-semibold">Parents</div>
              <div class="mt-3 grid gap-3">
                <input id="newGuardianName" class="rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-300/40" placeholder="Parent name"/>
                <input id="newGuardianEmail" type="email" autocomplete="email" class="rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-300/40" placeholder="Parent email"/>
                <button id="addGuardianBtn" class="px-4 py-3 rounded-2xl bg-indigo-500 text-white font-semibold hover:bg-indigo-600 transition">
                  Add
                </button>
              </div>
              <div id="guardianList" class="mt-4 max-h-[220px] overflow-auto rounded-2xl border border-white/10 bg-white/5"></div>
            </div>

            <div class="lg:col-span-4 rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="text-white/85 text-sm font-semibold">Children</div>
              <div class="mt-3 grid gap-3">
                <input id="newChildName" class="rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-300/40" placeholder="Child name"/>
                <button id="addChildBtn" class="px-4 py-3 rounded-2xl bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition">
                  Add
                </button>
              </div>
              <div id="childAdminList" class="mt-4 max-h-[220px] overflow-auto rounded-2xl border border-white/10 bg-white/5"></div>
            </div>
          </div>

          <div class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="text-white/85 text-sm font-semibold">Link (max 2 parents)</div>
            <div class="mt-4 grid md:grid-cols-3 gap-3">
              <select id="linkChildSelect" class="rounded-2xl border border-white/15 bg-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-300/40">
                <option value="">Child</option>
              </select>
              <select id="linkGuardianSelect" class="rounded-2xl border border-white/15 bg-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-300/40">
                <option value="">Parent</option>
              </select>
              <button id="linkBtn" class="px-4 py-3 rounded-2xl bg-white text-slate-900 font-semibold hover:bg-slate-100 transition">
                Link
              </button>
            </div>
            <div id="linkSummary" class="mt-4 text-white/70 text-sm"></div>
          </div>

          <div class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center justify-between">
              <div class="text-white/85 text-sm font-semibold">Pending</div>
              <span id="pendingCount" class="text-xs px-3 py-1 rounded-full bg-white/10 border border-white/15 text-white/80"></span>
            </div>
            <div id="pendingList" class="mt-4 max-h-[320px] overflow-auto rounded-2xl border border-white/10 bg-white/5"></div>
          </div>

          <div class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center justify-between">
              <div class="text-white/85 text-sm font-semibold">Today</div>
              <div class="text-white/60 text-xs" id="logCount"></div>
            </div>
            <div class="mt-4 overflow-auto rounded-2xl border border-white/10 bg-white/5">
              <table class="min-w-full text-sm">
                <thead class="sticky top-0 bg-slate-950/60 backdrop-blur border-b border-white/10">
                  <tr class="text-white/90">
                    <th class="text-left px-4 py-3 font-semibold">Parent</th>
                    <th class="text-left px-4 py-3 font-semibold">Staff</th>
                    <th class="text-left px-4 py-3 font-semibold">Action</th>
                    <th class="text-left px-4 py-3 font-semibold">Child</th>
                    <th class="text-left px-4 py-3 font-semibold">Email</th>
                    <th class="text-left px-4 py-3 font-semibold">Note</th>
                  </tr>
                </thead>
                <tbody id="logTbody" class="divide-y divide-white/5 text-white/85"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <!-- My Schools modal -->
  <div id="mySchoolsModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-xl rounded-3xl bg-white text-slate-900 shadow-2xl">
        <div class="p-5 md:p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">My Schools</h3>
            <button id="mySchoolsCloseBtn" class="px-3 py-2 rounded-xl hover:bg-slate-100">‚úï</button>
          </div>

          <div class="mt-4 text-sm text-slate-600">
            Choose a school you have access to (staff/owner). This is tied to your <b>one</b> login account.
          </div>

          <div id="mySchoolsList" class="mt-4 rounded-2xl border bg-slate-50 max-h-[360px] overflow-auto"></div>

          <div class="mt-4 flex gap-2">
            <button id="mySchoolsCancelBtn" class="px-4 py-3 rounded-2xl bg-slate-100 font-semibold hover:bg-slate-200">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Announcement modal -->
  <div id="announcementModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-xl rounded-3xl bg-white text-slate-900 shadow-2xl">
        <div class="p-5 md:p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Send Announcement</h3>
            <button id="announcementCloseBtn" class="px-3 py-2 rounded-xl hover:bg-slate-100">‚úï</button>
          </div>

          <div class="mt-4 text-sm text-slate-600">
            Send a message to all linked parents at this school.
          </div>

          <div class="mt-4 space-y-3">
            <input id="announcementSubject" class="w-full rounded-2xl border border-slate-200 bg-white text-slate-900 placeholder:text-slate-400 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-300" placeholder="Subject (optional)"/>
            <textarea id="announcementMessage" class="w-full rounded-2xl border border-slate-200 bg-white text-slate-900 placeholder:text-slate-400 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-300 resize-none" rows="4" placeholder="Message"></textarea>
          </div>

          <div class="mt-4 flex gap-2">
            <button id="announcementSendBtn" class="px-4 py-3 rounded-2xl bg-purple-500 text-white font-semibold hover:bg-purple-600">Send</button>
            <button id="announcementCancelBtn" class="px-4 py-3 rounded-2xl bg-slate-100 font-semibold hover:bg-slate-200">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* Firebase init */
const firebaseConfig = {
  apiKey: "AIzaSyC0vDzgPZllUU_gYU0iIYPiT4OWbj-eYHQ",
  authDomain: "preschool-a9bb0.firebaseapp.com",
  projectId: "preschool-a9bb0",
  storageBucket: "preschool-a9bb0.firebasestorage.app",
  messagingSenderId: "462699240938",
  appId: "1:462699240938:web:fad34d16574a062ce42693",
  measurementId: "G-PEL1T3XE2B"
};

firebase.initializeApp(firebaseConfig);
try { firebase.analytics(); } catch(e) {}

const AUTH = firebase.auth();
AUTH.useDeviceLanguage();
const DB   = firebase.firestore();

/* Helpers */
const pad2 = n => String(n).padStart(2,"0");
const todayKey = () => { const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
const nowLocal = () => { const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`; };
const esc = s => String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
const escA = s => esc(s).replaceAll("\n"," ");
const normalizeEmail = s => String(s||"").trim().toLowerCase();

function setStatus(msg, type="info") {
  statusWrap.classList.remove("hidden");
  const base = "rounded-2xl border px-4 py-3 text-sm";
  const styles = {
    ok:  "bg-emerald-400/10 border-emerald-200/20 text-emerald-50",
    err: "bg-rose-400/10 border-rose-200/20 text-rose-50",
    info:"bg-white/10 border-white/15 text-white/90"
  };
  statusMsg.className = `${base} ${styles[type] || styles.info}`;
  statusMsg.textContent = msg;
}
function updateOfflineUI(){ offlineBar.classList.toggle("hidden", navigator.onLine); }
window.addEventListener("online", updateOfflineUI);
window.addEventListener("offline", updateOfflineUI);

function safeSetInput(el, value){ if(document.activeElement === el) return; el.value = value ?? ""; }
function guardHosted(){
  if(location.protocol === "file:"){
    setStatus("Open from a hosted URL (not file://). Use Firebase Hosting / GitHub Pages / local server.", "err");
    return false;
  }
  return true;
}
function continueUrl(paramsObj){
  const u = new URL(location.origin + location.pathname);
  Object.entries(paramsObj || {}).forEach(([k,v]) => u.searchParams.set(k, v));
  return u.toString();
}

/* DOM */
const subTitle = document.getElementById("subTitle");
const logoutBtn = document.getElementById("logoutBtn");
const switchSchoolBtn = document.getElementById("switchSchoolBtn");
const mySchoolsBtn = document.getElementById("mySchoolsBtn");

const offlineBar = document.getElementById("offlineBar");
const schoolBadge = document.getElementById("schoolBadge");

const statusWrap = document.getElementById("statusWrap");
const statusMsg  = document.getElementById("statusMsg");

const rolePickView = document.getElementById("rolePickView");
const pickStaffBtn = document.getElementById("pickStaffBtn");
const pickParentBtn = document.getElementById("pickParentBtn");

const staffAuthCard = document.getElementById("staffAuthCard");
const parentAuthCard = document.getElementById("parentAuthCard");
const emailLinkHint = document.getElementById("emailLinkHint");

const backToRole1 = document.getElementById("backToRole1");
const backToRole2 = document.getElementById("backToRole2");

const staffView  = document.getElementById("staffView");
const parentView = document.getElementById("parentView");

/* Staff Auth */
const staffSchoolCode = document.getElementById("staffSchoolCode");
const staffEmail = document.getElementById("staffEmail");
const staffPassword = document.getElementById("staffPassword");
const staffLoginBtn = document.getElementById("staffLoginBtn");
const staffCreateBtn = document.getElementById("staffCreateBtn");
const forgotPasswordBtn = document.getElementById("forgotPasswordBtn");
const sendStaffEmailLinkBtn = document.getElementById("sendStaffEmailLinkBtn");

const schoolCodesList = document.getElementById("schoolCodesList");
const recentSchoolsSection = document.getElementById("recentSchoolsSection");
const recentSchoolsList = document.getElementById("recentSchoolsList");

/* Parent Auth */
const parentSchoolCode = document.getElementById("parentSchoolCode");
const parentEmail = document.getElementById("parentEmail");
const sendEmailLinkBtn = document.getElementById("sendEmailLinkBtn");

/* Parent */
const parentHeaderInfo = document.getElementById("parentHeaderInfo");
const parentIdentityText = document.getElementById("parentIdentityText");
const parentKidsList = document.getElementById("parentKidsList");
const parentPendingList = document.getElementById("parentPendingList");
const parentAnnouncementsList = document.getElementById("parentAnnouncementsList");
const pSelectedChild = document.getElementById("pSelectedChild");
const pSelectedStatus = document.getElementById("pSelectedStatus");
const pNotes = document.getElementById("pNotes");
const dropOffReqBtn = document.getElementById("dropOffReqBtn");
const pickUpReqBtn  = document.getElementById("pickUpReqBtn");
const clearParentSelectionBtn = document.getElementById("clearParentSelectionBtn");

/* Staff */
const staffRoleLine = document.getElementById("staffRoleLine");
const ownerPanel = document.getElementById("ownerPanel");
const staffList = document.getElementById("staffList");

const inviteStaffEmail = document.getElementById("inviteStaffEmail");
const inviteStaffRole = document.getElementById("inviteStaffRole");
const inviteBtn = document.getElementById("inviteBtn");
const inviteStaffName = document.getElementById("inviteStaffName");

const schoolName = document.getElementById("schoolName");
const className  = document.getElementById("className");
const staffName  = document.getElementById("staffName");
const saveSessionBtn = document.getElementById("saveSessionBtn");
const clearTodayBtn  = document.getElementById("clearTodayBtn");
const exportPdfBtn = document.getElementById("exportPdfBtn");
const exportCsvBtn = document.getElementById("exportCsvBtn");
const sendAnnouncementBtn = document.getElementById("sendAnnouncementBtn");

const newGuardianName = document.getElementById("newGuardianName");
const newGuardianEmail = document.getElementById("newGuardianEmail");
const addGuardianBtn  = document.getElementById("addGuardianBtn");
const guardianList    = document.getElementById("guardianList");

const newChildName = document.getElementById("newChildName");
const addChildBtn  = document.getElementById("addChildBtn");
const childAdminList = document.getElementById("childAdminList");

const linkChildSelect = document.getElementById("linkChildSelect");
const linkGuardianSelect = document.getElementById("linkGuardianSelect");
const linkBtn = document.getElementById("linkBtn");
const linkSummary = document.getElementById("linkSummary");

const pendingCount = document.getElementById("pendingCount");
const pendingList  = document.getElementById("pendingList");

const logCount = document.getElementById("logCount");
const logTbody = document.getElementById("logTbody");

/* My Schools modal */
const mySchoolsModal = document.getElementById("mySchoolsModal");
const mySchoolsCloseBtn = document.getElementById("mySchoolsCloseBtn");
const mySchoolsCancelBtn = document.getElementById("mySchoolsCancelBtn");
const mySchoolsList = document.getElementById("mySchoolsList");

/* Announcement modal */
const announcementModal = document.getElementById("announcementModal");
const announcementCloseBtn = document.getElementById("announcementCloseBtn");
const announcementCancelBtn = document.getElementById("announcementCancelBtn");
const announcementSendBtn = document.getElementById("announcementSendBtn");
const announcementSubject = document.getElementById("announcementSubject");
const announcementMessage = document.getElementById("announcementMessage");

/* State */
const LS_RECENT_SCHOOLS = "PRESCHOOL_RECENT_SCHOOLS";
const LS_EMAIL_FOR_LINK = "PRESCHOOL_EMAIL_FOR_LINK";
const LS_AUTH_INTENT = "PRESCHOOL_AUTH_INTENT"; // "staff" | "parent"
const LS_LINK_MODE = "PRESCHOOL_LINK_MODE";     // "staff" | "parent"

let APP = {
  schoolCode: null,
  role: null,              // "owner" | "staff" | "parent"
  user: null,
  isOwner: false,
  authIntent: null,

  settings: { schoolName:"", className:"", staffName:"" },
  guardians: [],
  children: [],
  pending: [],
  logs: [],
  staffRoster: [],
  announcements: [],

  selectedChildId: null,
  unsub: []
};

function setAuthIntent(x){
  APP.authIntent = x || null;
  try{ localStorage.setItem(LS_AUTH_INTENT, APP.authIntent || ""); }catch(e){}
}
function loadAuthIntent(){
  try{
    const v = localStorage.getItem(LS_AUTH_INTENT);
    APP.authIntent = v ? v : null;
  }catch(e){}
}

function userRef(){
  const uid = AUTH.currentUser?.uid;
  if(!uid) throw new Error("Not signed in");
  return DB.collection("users").doc(uid);
}
function membershipRef(schoolCode){
  const uid = AUTH.currentUser?.uid;
  if(!uid) throw new Error("Not signed in");
  const code = String(schoolCode||"").trim().toUpperCase();
  return DB.collection("users").doc(uid).collection("memberships").doc(code);
}

function setSchoolCode(code){
  const c = String(code||"").trim().toUpperCase();
  APP.schoolCode = c || null;
  if(APP.schoolCode){
    schoolBadge.textContent = `School: ${APP.schoolCode}`;
    schoolBadge.classList.remove("hidden");
  } else {
    schoolBadge.classList.add("hidden");
  }
}
function schoolRef(){
  if(!APP.schoolCode) throw new Error("Missing schoolCode");
  return DB.collection("schools").doc(APP.schoolCode);
}

/* Recent Schools */
function getRecentSchools() {
  try { return JSON.parse(localStorage.getItem(LS_RECENT_SCHOOLS) || "[]"); }
  catch { return []; }
}
function saveRecentSchool(code) {
  if (!code || !code.trim()) return;
  const codeUpper = code.trim().toUpperCase();
  let recent = getRecentSchools().filter(c => c !== codeUpper);
  recent.unshift(codeUpper);
  recent = recent.slice(0, 8);
  try { localStorage.setItem(LS_RECENT_SCHOOLS, JSON.stringify(recent)); } catch {}
  updateRecentSchoolsUI();
}
function updateRecentSchoolsUI() {
  const recent = getRecentSchools();
  if (recent.length === 0) {
    recentSchoolsSection.classList.add("hidden");
    schoolCodesList.innerHTML = "";
    return;
  }
  recentSchoolsSection.classList.remove("hidden");
  recentSchoolsList.innerHTML = recent.map(code =>
    `<button type="button" class="recent-school-btn px-3 py-1 rounded-xl bg-white/10 border border-white/15
             text-white/80 hover:text-white hover:bg-white/15 transition text-sm"
             data-school="${escA(code)}">${esc(code)}</button>`
  ).join("");
  schoolCodesList.innerHTML = recent.map(code => `<option value="${escA(code)}">`).join("");
  [...recentSchoolsList.querySelectorAll(".recent-school-btn")].forEach(btn => {
    btn.addEventListener("click", () => {
      staffSchoolCode.value = btn.getAttribute("data-school");
      staffSchoolCode.focus();
    });
  });
}

/* Views */
function showRolePick() {
  rolePickView.classList.remove("hidden");
  staffAuthCard.classList.add("hidden");
  parentAuthCard.classList.add("hidden");
  staffView.classList.add("hidden");
  parentView.classList.add("hidden");
  logoutBtn.classList.add("hidden");
  switchSchoolBtn.classList.add("hidden");
  mySchoolsBtn.classList.add("hidden");
  subTitle.textContent = "Welcome";
}
function showStaffAuth() {
  rolePickView.classList.add("hidden");
  staffAuthCard.classList.remove("hidden");
  parentAuthCard.classList.add("hidden");
  staffView.classList.add("hidden");
  parentView.classList.add("hidden");
  logoutBtn.classList.add("hidden");
  switchSchoolBtn.classList.add("hidden");
  mySchoolsBtn.classList.add("hidden");
  subTitle.textContent = "Staff login";
  updateRecentSchoolsUI();
}
function showParentAuth() {
  rolePickView.classList.add("hidden");
  staffAuthCard.classList.add("hidden");
  parentAuthCard.classList.remove("hidden");
  staffView.classList.add("hidden");
  parentView.classList.add("hidden");
  logoutBtn.classList.add("hidden");
  switchSchoolBtn.classList.add("hidden");
  mySchoolsBtn.classList.add("hidden");
  subTitle.textContent = "Parent login";
}
function showStaff() {
  rolePickView.classList.add("hidden");
  staffAuthCard.classList.add("hidden");
  parentAuthCard.classList.add("hidden");
  staffView.classList.remove("hidden");
  parentView.classList.add("hidden");
  logoutBtn.classList.remove("hidden");
  switchSchoolBtn.classList.remove("hidden");
  mySchoolsBtn.classList.remove("hidden");
  subTitle.textContent = "Staff";
}
function showParent() {
  rolePickView.classList.add("hidden");
  staffAuthCard.classList.add("hidden");
  parentAuthCard.classList.add("hidden");
  staffView.classList.add("hidden");
  parentView.classList.remove("hidden");
  logoutBtn.classList.remove("hidden");
  switchSchoolBtn.classList.remove("hidden");
  mySchoolsBtn.classList.add("hidden");
  subTitle.textContent = "Parent";
}
function stopListeners(){
  APP.unsub.forEach(fn=>{ try{ fn(); }catch{} });
  APP.unsub = [];
}

/* School creation (first staff becomes owner) */
async function ensureSchoolExistsAndOwnerClaim(){
  const uid = AUTH.currentUser?.uid;
  if(!uid || !APP.schoolCode) return;

  const metaRef = schoolRef();
  const snap = await metaRef.get().catch(()=>null);
  if(snap && snap.exists) return;

  const ownerEmail = normalizeEmail(AUTH.currentUser?.email);

  await metaRef.set({
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    ownerUid: uid,
    ownerEmail: ownerEmail
  });

  await metaRef.collection("staff").doc(uid).set({
    uid,
    email: ownerEmail,
    role: "owner",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  await metaRef.collection("settings").doc("main").set({
    schoolName: "",
    className: "",
    staffName: ""
  }, { merge:true });
}

async function upsertUserMembership(schoolCode, role){
  const uid = AUTH.currentUser?.uid;
  if(!uid) return;
  const code = String(schoolCode||"").trim().toUpperCase();
  if(!code) return;

  await membershipRef(code).set({
    schoolCode: code,
    role: role || "member",
    email: normalizeEmail(AUTH.currentUser?.email),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });
}

async function getMyRoleInSchool(){
  const uid = AUTH.currentUser?.uid;
  if(!uid) return { isStaff:false, isOwner:false, role:null };

  const sref = schoolRef();
  const [metaSnap, staffSnap] = await Promise.all([
    sref.get().catch(()=>null),
    sref.collection("staff").doc(uid).get().catch(()=>null)
  ]);

  const meta = metaSnap?.exists ? metaSnap.data() : null;
  const isOwner = !!meta?.ownerUid && meta.ownerUid === uid;
  const isStaff = !!staffSnap?.exists || isOwner;
  const role = isOwner ? "owner" : (isStaff ? "staff" : null);

  return { isStaff, isOwner, role, meta, staffDoc: staffSnap?.exists ? staffSnap.data(): null };
}

/* Invite flow */
async function createStaffInviteByEmail(){
  if(!APP.isOwner) return setStatus("Owner only.", "err");
  const email = normalizeEmail(inviteStaffEmail.value||"");
  const name = (inviteStaffName.value||"").trim();
  const role = inviteStaffRole.value || "staff";
  if(!email || !email.includes("@")) return setStatus("Enter valid email.", "err");
  if(!name) return setStatus("Enter staff name.", "err");

  await schoolRef().collection("staffInvites").doc(email).set({
    email,
    name,
    role,
    invitedByUid: AUTH.currentUser.uid,
    invitedByEmail: normalizeEmail(AUTH.currentUser.email),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  inviteStaffEmail.value = "";
  inviteStaffName.value = "";
  setStatus("Invite created. Staff can sign in using Staff Email Link (recommended).", "ok");
}

async function acceptInviteIfAny(){
  if(!APP.schoolCode) return;
  const email = normalizeEmail(AUTH.currentUser?.email);
  if(!email) return;

  const invRef = schoolRef().collection("staffInvites").doc(email);
  const inv = await invRef.get().catch(()=>null);
  if(!inv?.exists) return;

  const data = inv.data() || {};
  const role = data.role === "owner" ? "owner" : "staff";

  await schoolRef().collection("staff").doc(AUTH.currentUser.uid).set({
    uid: AUTH.currentUser.uid,
    email,
    name: data.name || "",
    role,
    addedFromInvite: true,
    invitedAt: data.createdAt || null,
    addedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  await upsertUserMembership(APP.schoolCode, role);
  setStatus("Invite accepted. You now have staff access for this school.", "ok");
}

/* Firestore sync */
function onSnapError(err){
  console.error(err);
  const msg = String(err?.message||"Error");
  if(msg.toLowerCase().includes("offline")){
    updateOfflineUI();
    setStatus("Offline / blocked network.", "err");
  } else {
    setStatus(msg, "err");
  }
}

function bindSchoolDataForStaff(){
  stopListeners();
  const sref = schoolRef();

  APP.unsub.push(
    sref.collection("staff").onSnapshot((snap)=>{
      APP.staffRoster = snap.docs.map(d=>({ id:d.id, ...d.data() }))
        .sort((a,b)=>{
          const aKey = a.name || a.email || a.id;
          const bKey = b.name || b.email || b.id;
          return String(aKey).localeCompare(String(bKey));
        });
      renderStaffRoster();
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("settings").doc("main").onSnapshot((doc)=>{
      APP.settings = doc.exists ? doc.data() : { schoolName:"", className:"", staffName:"" };
      safeSetInput(schoolName, APP.settings.schoolName || "");
      safeSetInput(className, APP.settings.className || "");
      safeSetInput(staffName, APP.settings.staffName || "");
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("guardians").onSnapshot((snap)=>{
      APP.guardians = snap.docs.map(d=>({ id:d.id, ...d.data() }))
        .sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
      renderGuardianList();
      renderLinkDropdowns();
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("children").onSnapshot((snap)=>{
      APP.children = snap.docs.map(d=>({ id:d.id, ...d.data() }))
        .sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
      renderChildAdminList();
      renderLinkDropdowns();
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("pending").orderBy("requestedAtTs","desc").onSnapshot((snap)=>{
      APP.pending = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderPending();
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("logs").where("date","==", todayKey()).orderBy("staffTimeTs","desc").onSnapshot((snap)=>{
      APP.logs = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderLogs();
    }, onSnapError)
  );
}

function bindSchoolDataForParent(){
  stopListeners();
  const sref = schoolRef();
  const email = normalizeEmail(AUTH.currentUser?.email);
  if(!email) return;

  APP.unsub.push(
    sref.collection("settings").doc("main").onSnapshot((doc)=>{
      APP.settings = doc.exists ? doc.data() : { schoolName:"", className:"", staffName:"" };
      renderParentHeader();
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("children").where("guardianEmails","array-contains", email).onSnapshot((snap)=>{
      APP.children = snap.docs.map(d=>({ id:d.id, ...d.data() }))
        .sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
      renderParentKids();
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("pending").where("guardianEmail","==", email).orderBy("requestedAtTs","desc").onSnapshot((snap)=>{
      APP.pending = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderParentPending();
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("announcements").orderBy("sentAtTs", "desc").limit(10).onSnapshot((snap)=>{
      APP.announcements = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderParentAnnouncements();
    }, onSnapError)
  );
}

/* Render */
function renderParentHeader(){
  const parts = [APP.settings.schoolName, APP.settings.className].filter(Boolean);
  parentHeaderInfo.textContent = parts.join(" ‚Ä¢ ");
  parentIdentityText.textContent = AUTH.currentUser?.email || "";
}
function clearParentSelection(){
  APP.selectedChildId = null;
  pSelectedChild.textContent = "Select a child";
  pSelectedStatus.textContent = "";
  pNotes.value = "";
}

function renderParentKids(){
  const kids = (APP.children||[]);
  if(!kids.length){
    parentKidsList.innerHTML = `<div class="p-4 text-white/60 text-sm">No linked children.</div>`;
    clearParentSelection();
    return;
  }
  parentKidsList.innerHTML = kids.map(c=>{
    const st = c.lastAction || null;
    let pillHtml = "";
    if(st === "DROP_OFF"){
      pillHtml = `<span class="text-xs px-3 py-1 rounded-full border bg-emerald-400/10 border-emerald-200/20 text-emerald-50">IN</span>`;
    } else if(st === "PICK_UP"){
      pillHtml = `<span class="text-xs px-3 py-1 rounded-full border bg-indigo-400/10 border-indigo-200/20 text-indigo-50">OUT</span>`;
    }
    return `
      <button data-kid="${escA(c.id)}" class="w-full text-left p-4 flex items-center justify-between gap-3 hover:bg-white/5 transition">
        <div class="text-white font-semibold">${esc(c.name||"")}</div>
        ${pillHtml}
      </button>
    `;
  }).join("");
  [...parentKidsList.querySelectorAll("button[data-kid]")].forEach(btn=>{
    btn.addEventListener("click", ()=>{
      APP.selectedChildId = btn.getAttribute("data-kid");
      const child = APP.children.find(c=>c.id===APP.selectedChildId);
      pSelectedChild.textContent = child?.name || "Select a child";
      const st = child?.lastAction || null;
      pSelectedStatus.textContent = st ? `Status: ${st==="DROP_OFF"?"IN":"OUT"}` : "";
      setStatus("Selected.", "ok");
    });
  });
}

function renderParentPending(){
  const list = (APP.pending||[]).slice(0,8);
  parentPendingList.innerHTML = list.length
    ? list.map(p=>`<div class="text-white/85">‚Ä¢ ${esc(p.childName||"")} ‚Äî ${p.action==="DROP_OFF"?"Drop-off":"Pick-up"} (waiting)</div>`).join("")
    : "None";
}
function renderParentAnnouncements(){
  const announcements = (APP.announcements||[]);
  if(!announcements.length){
    parentAnnouncementsList.innerHTML = `<div class="text-white/60">No announcements</div>`;
    return;
  }
  parentAnnouncementsList.innerHTML = announcements.map(a=>`
    <div class="mb-3 pb-3 border-b border-white/10 last:border-b-0 last:pb-0 last:mb-0">
      <div class="text-white font-semibold text-sm">${esc(a.subject||"Announcement")}</div>
      <div class="text-white/80 text-xs mt-1">${esc(a.message||"")}</div>
      <div class="text-white/50 text-xs mt-1">From: ${esc(a.sentBy||"")} ‚Ä¢ ${esc(a.sentAt||"")}</div>
    </div>
  `).join("");
}

function renderStaffRoster(){
  if(!APP.isOwner){
    ownerPanel.classList.add("hidden");
    return;
  }
  ownerPanel.classList.remove("hidden");

  const list = (APP.staffRoster||[]);
  if(!list.length){
    staffList.innerHTML = `<div class="p-4 text-white/60 text-sm">No staff yet.</div>`;
    return;
  }
  staffList.innerHTML = list.map(s=>{
    const isOwner = s.role === "owner";
    const displayName = s.name || s.email || "(no name)";
    const secondaryInfo = s.name ? s.email : "";
    return `
      <div class="p-3 border-b border-white/5 flex items-center justify-between gap-3">
        <div>
          <div class="text-white font-semibold">${esc(displayName)}</div>
          ${secondaryInfo ? `<div class="text-white/60 text-xs">${esc(secondaryInfo)}</div>` : ""}
          <div class="text-white/60 text-xs">${isOwner ? "Owner" : "Staff"}</div>
        </div>
        ${isOwner ? "" : `
          <button data-demote="${escA(s.uid||s.id)}" class="text-xs px-3 py-2 rounded-xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
            Remove
          </button>
        `}
      </div>
    `;
  }).join("");

  [...staffList.querySelectorAll("button[data-demote]")].forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const uid = btn.getAttribute("data-demote");
      if(!confirm("Remove staff access for this user?")) return;
      await schoolRef().collection("staff").doc(uid).delete();
      setStatus("Staff removed.", "info");
    });
  });
}

function renderGuardianList(){
  const gs = (APP.guardians||[]);
  if(!gs.length){
    guardianList.innerHTML = `<div class="p-4 text-white/60 text-sm">No parents</div>`;
    return;
  }
  guardianList.innerHTML = gs.map(g=>`
    <div class="p-3 border-b border-white/5 flex items-center justify-between gap-3">
      <div>
        <div class="text-white font-semibold">${esc(g.name||"")}</div>
        <div class="text-white/60 text-xs">${esc(g.email||"")}</div>
      </div>
      <button data-delg="${escA(g.id)}" class="text-xs px-3 py-2 rounded-xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
        Remove
      </button>
    </div>
  `).join("");

  [...guardianList.querySelectorAll("button[data-delg]")].forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-delg");
      if(!confirm("Remove parent?")) return;
      await schoolRef().collection("guardians").doc(id).delete();
      setStatus("Removed.", "info");
    });
  });
}

function renderChildAdminList(){
  const cs = (APP.children||[]);
  if(!cs.length){
    childAdminList.innerHTML = `<div class="p-4 text-white/60 text-sm">No children</div>`;
    return;
  }
  childAdminList.innerHTML = cs.map(c=>{
    const emails = (c.guardianEmails||[]).filter(Boolean);
    return `
      <div class="p-3 border-b border-white/5 flex items-start justify-between gap-3">
        <div>
          <div class="text-white font-semibold">${esc(c.name||"")}</div>
          <div class="text-white/60 text-xs mt-1">
            ${emails.length ? emails.map(e=>`‚Ä¢ ${esc(e)}`).join("<br/>") : "No linked parents"}
          </div>
        </div>
        <button data-delc="${escA(c.id)}" class="text-xs px-3 py-2 rounded-xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
          Remove
        </button>
      </div>
    `;
  }).join("");

  [...childAdminList.querySelectorAll("button[data-delc]")].forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-delc");
      if(!confirm("Remove child?")) return;
      await schoolRef().collection("children").doc(id).delete();
      setStatus("Removed.", "info");
    });
  });
}

function renderLinkDropdowns(){
  linkChildSelect.innerHTML = `<option value="">Child</option>` +
    (APP.children||[]).map(c=>`<option value="${escA(c.id)}">${esc(c.name||"")}</option>`).join("");

  linkGuardianSelect.innerHTML = `<option value="">Parent</option>` +
    (APP.guardians||[]).map(g=>`<option value="${escA(g.id)}">${esc(g.name||"")} (${esc(g.email||"")})</option>`).join("");

  linkSummary.textContent = `${(APP.children||[]).length} children ‚Ä¢ ${(APP.guardians||[]).length} parents ‚Ä¢ max 2`;
}

function renderPending(){
  pendingCount.textContent = `${(APP.pending||[]).length} pending`;
  const list = (APP.pending||[]);
  if(!list.length){
    pendingList.innerHTML = `<div class="p-4 text-white/60 text-sm">None</div>`;
    return;
  }
  pendingList.innerHTML = list.map(p=>{
    const pill = p.action==="DROP_OFF" ? "bg-emerald-400/10 border-emerald-200/20 text-emerald-50"
                                      : "bg-indigo-400/10 border-indigo-200/20 text-indigo-50";
    return `
      <div class="p-4 border-b border-white/5 flex items-start justify-between gap-3">
        <div>
          <div class="text-white font-semibold">${esc(p.childName||"")}</div>
          <div class="mt-1 text-white/70 text-sm">
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs border ${pill}">
              ${p.action==="DROP_OFF"?"Drop-off":"Pick-up"}
            </span>
            <span class="ml-2">${esc(p.guardianEmail||"")}</span>
          </div>
          <div class="mt-1 text-white/60 text-xs">Parent: ${esc(p.requestedAt||"")}</div>
          ${p.notes ? `<div class="mt-1 text-white/70 text-xs">Note: ${esc(p.notes)}</div>` : ""}
        </div>
        <div class="flex flex-col gap-2">
          <button data-approve="${escA(p.id)}" class="text-xs px-3 py-2 rounded-xl bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition">Approve</button>
          <button data-reject="${escA(p.id)}" class="text-xs px-3 py-2 rounded-xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">Reject</button>
        </div>
      </div>
    `;
  }).join("");

  [...pendingList.querySelectorAll("button[data-approve]")].forEach(btn=>{
    btn.addEventListener("click", ()=>approvePending(btn.getAttribute("data-approve")));
  });
  [...pendingList.querySelectorAll("button[data-reject]")].forEach(btn=>{
    btn.addEventListener("click", ()=>rejectPending(btn.getAttribute("data-reject")));
  });
}

function renderLogs(){
  const rows = (APP.logs||[]);
  logCount.textContent = `${rows.length} entries`;
  if(!rows.length){
    logTbody.innerHTML = `<tr><td class="px-4 py-6 text-white/60" colspan="6">No entries yet.</td></tr>`;
    return;
  }
  logTbody.innerHTML = rows.map(r=>{
    const pill = r.action==="DROP_OFF" ? "bg-emerald-400/10 border-emerald-200/20 text-emerald-50"
                                      : "bg-indigo-400/10 border-indigo-200/20 text-indigo-50";
    return `
      <tr class="hover:bg-white/5 transition">
        <td class="px-4 py-3 whitespace-nowrap">${esc(r.parentTime||"")}</td>
        <td class="px-4 py-3 whitespace-nowrap">${esc(r.staffTime||"")}</td>
        <td class="px-4 py-3">
          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs border ${pill}">
            ${r.action==="DROP_OFF"?"Drop-off":"Pick-up"}
          </span>
        </td>
        <td class="px-4 py-3">${esc(r.childName||"")}</td>
        <td class="px-4 py-3">${esc(r.guardianEmail||"")}</td>
        <td class="px-4 py-3 max-w-[260px] truncate" title="${escA(r.notes||"")}">${esc(r.notes||"")}</td>
      </tr>
    `;
  }).join("");
}

/* Staff CRUD + linking */
async function saveSettings(){
  await schoolRef().collection("settings").doc("main").set({
    schoolName: (schoolName.value||"").trim(),
    className:  (className.value||"").trim(),
    staffName:  (staffName.value||"").trim()
  }, { merge:true });
  setStatus("Saved.", "ok");
}

async function addGuardian(){
  const name = (newGuardianName.value||"").trim();
  const email = normalizeEmail(newGuardianEmail.value||"");
  if(!name) return setStatus("Enter name.", "err");
  if(!email || !email.includes("@")) return setStatus("Enter valid email.", "err");

  const existing = await schoolRef().collection("guardians").where("email","==",email).limit(1).get();
  if(!existing.empty) return setStatus("Email exists.", "err");

  await schoolRef().collection("guardians").add({
    name, email,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  newGuardianName.value = "";
  newGuardianEmail.value = "";
  setStatus("Added.", "ok");
}

async function addChild(){
  const name = (newChildName.value||"").trim();
  if(!name) return setStatus("Enter child name.", "err");
  await schoolRef().collection("children").add({
    name,
    guardianEmails: [],
    lastAction: null,
    lastActionAt: null,
    lastUpdatedBy: "",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  newChildName.value = "";
  setStatus("Added.", "ok");
}

async function linkParentToChild(){
  const childId = linkChildSelect.value;
  const guardianId = linkGuardianSelect.value;
  if(!childId || !guardianId) return setStatus("Select both.", "err");

  const g = APP.guardians.find(x=>x.id===guardianId);
  if(!g) return setStatus("Parent missing.", "err");

  const cRef = schoolRef().collection("children").doc(childId);
  const cSnap = await cRef.get();
  if(!cSnap.exists) return setStatus("Child missing.", "err");
  const c = cSnap.data();

  const emails = Array.isArray(c.guardianEmails) ? c.guardianEmails.slice() : [];
  if(emails.includes(g.email)) return setStatus("Already linked.", "info");
  if(emails.length >= 2) return setStatus("Max 2 parents.", "err");

  emails.push(g.email);
  await cRef.set({ guardianEmails: emails }, { merge:true });

  await schoolRef().collection("parentAccess").doc(normalizeEmail(g.email)).set({
    email: normalizeEmail(g.email),
    addedAt: firebase.firestore.FieldValue.serverTimestamp(),
    addedBy: AUTH.currentUser.uid
  }, { merge:true });

  setStatus("Linked.", "ok");
}

/* Parent creates pending */
async function createPending(action){
  if(APP.role !== "parent") return;
  const email = normalizeEmail(AUTH.currentUser?.email);
  if(!email) return setStatus("Missing email.", "err");
  if(!APP.selectedChildId) return setStatus("Select a child first.", "err");

  const child = APP.children.find(c=>c.id===APP.selectedChildId);
  if(!child) return setStatus("Child not found.", "err");

  const note = (pNotes.value||"").trim();

  await schoolRef().collection("pending").add({
    schoolCode: APP.schoolCode,
    action,
    childId: child.id,
    childName: child.name || "",
    guardianEmail: email,
    notes: note,
    requestedAt: nowLocal(),
    requestedAtTs: firebase.firestore.FieldValue.serverTimestamp()
  });

  setStatus("Request sent.", "ok");
  pNotes.value = "";
}

/* Staff approves/rejects pending */
async function approvePending(pendingId){
  if(APP.role!=="staff" && APP.role!=="owner") return;
  const sref = schoolRef();
  const now = nowLocal();
  const date = todayKey();

  await DB.runTransaction(async (tx)=>{
    const pref = sref.collection("pending").doc(pendingId);
    const psnap = await tx.get(pref);
    if(!psnap.exists) return;

    const p = psnap.data();
    const childRef = sref.collection("children").doc(p.childId);
    const logRef = sref.collection("logs").doc();

    tx.set(logRef, {
      date,
      parentTime: p.requestedAt || "",
      parentTimeTs: p.requestedAtTs || null,
      staffTime: now,
      staffTimeTs: firebase.firestore.FieldValue.serverTimestamp(),
      action: p.action,
      childId: p.childId,
      childName: p.childName || "",
      guardianEmail: p.guardianEmail || "",
      notes: p.notes || "",
      staffName: (APP.settings.staffName||"").trim(),
      approvedByUid: AUTH.currentUser.uid,
      approvedByEmail: normalizeEmail(AUTH.currentUser.email)
    });

    tx.set(childRef, {
      lastAction: p.action,
      lastActionAt: now,
      lastUpdatedBy: normalizeEmail(AUTH.currentUser.email)
    }, { merge:true });

    tx.delete(pref);
  });

  setStatus("Approved.", "ok");
}

async function rejectPending(pendingId){
  if(APP.role!=="staff" && APP.role!=="owner") return;
  if(!confirm("Reject this request?")) return;
  await schoolRef().collection("pending").doc(pendingId).delete();
  setStatus("Rejected.", "info");
}

/* Export + archive + clear */
async function exportAndArchive(kind){
  if(APP.role!=="staff" && APP.role!=="owner") return setStatus("Staff only.", "err");
  if(!APP.logs.length) return setStatus("No logs.", "err");

  const sref = schoolRef();
  const date = todayKey();

  if(kind==="csv"){
    const headers = ["date","parentTime","staffTime","action","childName","guardianEmail","notes","staffName","schoolName","className"];
    const csvEscape = v => `"${String(v ?? "").replaceAll('"','""')}"`;
    const rows = APP.logs.slice().reverse().map(r => headers.map(h => csvEscape(
      h==="schoolName" ? (APP.settings.schoolName||"") :
      h==="className" ? (APP.settings.className||"") :
      h==="staffName" ? (APP.settings.staffName||r.staffName||"") :
      r[h]
    )));
    const csv = [headers.join(","), ...rows.map(r=>r.join(","))].join("\n");
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download=`daily_log_${date}.csv`; a.click();
    URL.revokeObjectURL(url);
  }

  if(kind==="pdf"){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"letter" });
    const margin=40; let y=52;

    doc.setFont("helvetica","bold"); doc.setFontSize(16);
    doc.text(`${APP.settings.schoolName || "School"} ‚Äî Daily Log`, margin, y);

    doc.setFont("helvetica","normal"); doc.setFontSize(11);
    y+=20; doc.text(`Date: ${date}    Class: ${APP.settings.className || ""}`, margin, y);
    y+=16; doc.text(`Staff: ${APP.settings.staffName || ""}`, margin, y);
    y+=16; doc.text(`Generated: ${nowLocal()}`, margin, y);
    y+=18;

    const body = APP.logs.slice().reverse().map(r => ([
      r.parentTime, r.staffTime,
      r.action==="DROP_OFF" ? "Drop-off" : "Pick-up",
      r.childName,
      r.guardianEmail,
      (r.notes||"").slice(0,90),
    ]));

    doc.autoTable({
      startY: y,
      head: [["Parent Time","Staff Time","Action","Child","Parent Email","Notes"]],
      body,
      theme: "grid",
      styles: { font:"helvetica", fontSize: 9, cellPadding: 4, overflow:"linebreak" },
      headStyles: { fillColor: [20,20,20], textColor: 255 },
      margin: { left: margin, right: margin }
    });

    doc.save(`daily_log_${date}.pdf`);
  }

  await sref.collection("archives").doc(date).set({
    date,
    exportedAt: nowLocal(),
    header: { ...APP.settings },
    logs: APP.logs.slice().reverse()
  }, { merge:true });

  const batch = DB.batch();
  const pendSnap = await sref.collection("pending").get();
  pendSnap.forEach(d=>batch.delete(d.ref));
  const logsSnap = await sref.collection("logs").where("date","==",date).get();
  logsSnap.forEach(d=>batch.delete(d.ref));
  await batch.commit();

  setStatus("Exported + cleared.", "ok");
}
async function clearToday(){
  if(APP.role!=="staff" && APP.role!=="owner") return setStatus("Staff only.", "err");
  if(!confirm("Clear today?")) return;

  const sref = schoolRef();
  const date = todayKey();

  const batch = DB.batch();
  const pendSnap = await sref.collection("pending").get();
  pendSnap.forEach(d=>batch.delete(d.ref));
  const logsSnap = await sref.collection("logs").where("date","==",date).get();
  logsSnap.forEach(d=>batch.delete(d.ref));
  await batch.commit();

  setStatus("Cleared.", "ok");
}

/* Email Link Auth (Parent + Staff) */
async function sendEmailLink(mode){
  if(!guardHosted()) return;

  const isStaff = mode === "staff";
  const code = (isStaff ? (staffSchoolCode.value||"") : (parentSchoolCode.value||"")).trim().toUpperCase();
  const email = normalizeEmail(isStaff ? (staffEmail.value||"") : (parentEmail.value||""));
  if(!code) return setStatus("Enter school code.", "err");
  if(!email || !email.includes("@")) return setStatus("Enter valid email.", "err");

  setAuthIntent(isStaff ? "staff" : "parent");
  setSchoolCode(code);

  // Store email & mode for completion
  localStorage.setItem(LS_EMAIL_FOR_LINK, email);
  localStorage.setItem(LS_LINK_MODE, isStaff ? "staff" : "parent");

  const url = continueUrl({ school: code, mode: isStaff ? "staff" : "parent" });
  const actionCodeSettings = { url, handleCodeInApp: true };

  const btn = isStaff ? sendStaffEmailLinkBtn : sendEmailLinkBtn;
  btn.disabled = true;
  const oldText = btn.textContent;
  btn.textContent = "Sending...";
  try{
    await AUTH.sendSignInLinkToEmail(email, actionCodeSettings);
  } finally {
    btn.disabled = false;
    btn.textContent = oldText;
  }

  emailLinkHint.classList.remove("hidden");
  setStatus("Login link sent. Check inbox + spam/promotions.", "ok");
}

async function completeEmailLinkIfPresent(){
  if(!AUTH.isSignInWithEmailLink(window.location.href)) return;

  emailLinkHint.classList.remove("hidden");

  const u = new URL(window.location.href);
  const school = (u.searchParams.get("school") || "").trim().toUpperCase();
  const mode = (u.searchParams.get("mode") || "").trim().toLowerCase(); // staff | parent
  if(school) setSchoolCode(school);

  const storedMode = (localStorage.getItem(LS_LINK_MODE) || mode || "parent").toLowerCase();
  setAuthIntent(storedMode === "staff" ? "staff" : "parent");

  let email = localStorage.getItem(LS_EMAIL_FOR_LINK);
  if(!email) email = normalizeEmail(prompt("Confirm your email to finish login:") || "");
  if(!email) return setStatus("Email is required to finish login.", "err");

  await AUTH.signInWithEmailLink(email, window.location.href);
  localStorage.removeItem(LS_EMAIL_FOR_LINK);
  localStorage.removeItem(LS_LINK_MODE);

  const clean = location.pathname + (APP.schoolCode ? `?school=${encodeURIComponent(APP.schoolCode)}` : "");
  window.history.replaceState({}, document.title, clean);
}

/* My Schools modal */
function openMySchoolsModal(){
  if(!AUTH.currentUser) return;
  mySchoolsModal.classList.remove("hidden");
  loadMySchools();
}
function closeMySchoolsModal(){ mySchoolsModal.classList.add("hidden"); }

async function loadMySchools(){
  mySchoolsList.innerHTML = `<div class="p-4 text-slate-600 text-sm">Loading...</div>`;
  try{
    const snap = await userRef().collection("memberships").get();
    const items = snap.docs.map(d=>d.data()).sort((a,b)=>String(a.schoolCode).localeCompare(String(b.schoolCode)));
    if(!items.length){
      mySchoolsList.innerHTML = `<div class="p-4 text-slate-600 text-sm">No school memberships yet.</div>`;
      return;
    }
    mySchoolsList.innerHTML = items.map(m=>`
      <button class="w-full text-left p-4 border-b last:border-b-0 hover:bg-slate-100 transition" data-school="${escA(m.schoolCode)}">
        <div class="font-semibold text-slate-900">${esc(m.schoolCode)}</div>
        <div class="text-xs text-slate-600">Role: ${esc(m.role||"member")}</div>
      </button>
    `).join("");

    [...mySchoolsList.querySelectorAll("button[data-school]")].forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const code = btn.getAttribute("data-school");
        closeMySchoolsModal();
        await switchToSchool(code);
      });
    });
  } catch(e){
    console.error(e);
    mySchoolsList.innerHTML = `<div class="p-4 text-rose-600 text-sm">${esc(e?.message||"Error")}</div>`;
  }
}
async function switchToSchool(code){
  stopListeners();
  setSchoolCode(code);
  setStatus(`Switching to school ${code}...`, "info");
  await routeAfterAuth();
}

/* Announcements */
function openAnnouncementModal(){
  announcementModal.classList.remove("hidden");
  announcementSubject.value = "";
  announcementMessage.value = "";
  announcementSubject.focus();
}
function closeAnnouncementModal(){ announcementModal.classList.add("hidden"); }

async function sendAnnouncement(){
  const subject = announcementSubject.value.trim();
  const message = announcementMessage.value.trim();
  if(!message) return alert("Please enter a message.");

  try{
    setStatus("Sending announcement...", "info");
    await schoolRef().collection("announcements").add({
      subject: subject || "Announcement",
      message,
      sentBy: normalizeEmail(AUTH.currentUser?.email) || "staff",
      sentAt: nowLocal(),
      sentAtTs: firebase.firestore.FieldValue.serverTimestamp()
    });
    closeAnnouncementModal();
    setStatus("Announcement sent!", "ok");
  }catch(e){
    console.error(e);
    setStatus("Failed: " + (e?.message||"Error"), "err");
  }
}

/* Auth routing */
async function routeAfterAuth(){
  APP.isOwner = false;
  staffRoleLine.textContent = "";
  ownerPanel.classList.add("hidden");

  if(!AUTH.currentUser){
    APP.role = null;
    stopListeners();
    showRolePick();
    return;
  }

  if(!APP.schoolCode){
    showRolePick();
    return setStatus("Select role and enter school code to continue.", "info");
  }

  // STAFF intent
  if(APP.authIntent === "staff"){
    await ensureSchoolExistsAndOwnerClaim();
    await acceptInviteIfAny();

    const info = await getMyRoleInSchool();
    APP.isOwner = !!info.isOwner;

    if(info.isStaff){
      APP.role = APP.isOwner ? "owner" : "staff";
      showStaff();
      bindSchoolDataForStaff();
      staffRoleLine.textContent = APP.isOwner ? "Role: OWNER" : "Role: STAFF";
      await upsertUserMembership(APP.schoolCode, APP.role);
      setStatus(APP.isOwner ? "Owner signed in." : "Staff signed in.", "ok");
      return;
    }

    APP.role = null;
    stopListeners();
    showStaffAuth();
    setStatus("No staff access for this school. Ask the Owner to invite your email.", "err");
    return;
  }

  // PARENT intent
  APP.role = "parent";
  showParent();
  bindSchoolDataForParent();
  setStatus("Parent signed in.", "ok");
}

AUTH.onAuthStateChanged(async (user)=>{
  APP.user = user || null;
  try{
    if(!user){
      APP.role = null;
      stopListeners();
      showRolePick();
      return;
    }
    await routeAfterAuth();
  }catch(e){
    console.error(e);
    setStatus(e?.message || "Auth routing error", "err");
  }
});

/* Events */
logoutBtn.addEventListener("click", async ()=>{
  stopListeners();
  await AUTH.signOut();
  setStatus("Logged out.", "info");
  setSchoolCode(null);
  setAuthIntent(null);
  showRolePick();
});

switchSchoolBtn.addEventListener("click", async ()=>{
  stopListeners();
  setSchoolCode(null);
  APP.role = null;
  APP.isOwner = false;
  setStatus("Select a school to continue.", "info");
  showRolePick();
});

mySchoolsBtn.addEventListener("click", openMySchoolsModal);
mySchoolsCloseBtn.addEventListener("click", closeMySchoolsModal);
mySchoolsCancelBtn.addEventListener("click", closeMySchoolsModal);
mySchoolsModal.addEventListener("click", (e)=>{ if(e.target===mySchoolsModal) closeMySchoolsModal(); });

sendAnnouncementBtn.addEventListener("click", openAnnouncementModal);
announcementCloseBtn.addEventListener("click", closeAnnouncementModal);
announcementCancelBtn.addEventListener("click", closeAnnouncementModal);
announcementSendBtn.addEventListener("click", sendAnnouncement);
announcementModal.addEventListener("click", (e)=>{ if(e.target===announcementModal) closeAnnouncementModal(); });

pickStaffBtn.addEventListener("click", ()=>{ setAuthIntent("staff"); showStaffAuth(); });
pickParentBtn.addEventListener("click", ()=>{ setAuthIntent("parent"); showParentAuth(); });
backToRole1.addEventListener("click", ()=>{ showRolePick(); });
backToRole2.addEventListener("click", ()=>{ showRolePick(); });

/* Staff password-based create/login (still supported) */
staffCreateBtn.addEventListener("click", async ()=>{
  try{
    setAuthIntent("staff");
    const code = (staffSchoolCode.value||"").trim().toUpperCase();
    const email = normalizeEmail(staffEmail.value||"");
    const pass  = (staffPassword.value||"").trim();

    if(!code) return setStatus("Please enter a school code.", "err");
    if(!email || !pass) return setStatus("Enter email/password.", "err");

    setSchoolCode(code);
    saveRecentSchool(code);

    await AUTH.createUserWithEmailAndPassword(email, pass);
    setStatus("Account created. You are now signed in.", "ok");
    await routeAfterAuth();
  }catch(e){
    console.error(e);
    const msg = String(e?.message||"Error");
    if(msg.toLowerCase().includes("already")){
      setStatus("This email already has an account. Use Login or Email Link.", "err");
    }else{
      setStatus(msg, "err");
    }
  }
});

staffLoginBtn.addEventListener("click", async ()=>{
  try{
    setAuthIntent("staff");
    const code = (staffSchoolCode.value||"").trim().toUpperCase();
    const email = normalizeEmail(staffEmail.value||"");
    const pass  = (staffPassword.value||"").trim();

    if(!code) return setStatus("Please enter a school code.", "err");
    if(!email || !pass) return setStatus("Enter email/password.", "err");

    setSchoolCode(code);
    saveRecentSchool(code);

    await AUTH.signInWithEmailAndPassword(email, pass);
    await routeAfterAuth();
  }catch(e){
    console.error(e);
    setStatus(e?.message || "Error", "err");
  }
});

forgotPasswordBtn.addEventListener("click", async ()=>{
  try{
    const email = normalizeEmail(staffEmail.value||"");
    if(!email || !email.includes("@")) return setStatus("Enter a valid email address first.", "err");
    await AUTH.sendPasswordResetEmail(email);
    setStatus("Password reset email sent. Check your inbox.", "ok");
  }catch(e){
    console.error(e);
    setStatus(e?.message || "Error sending reset email", "err");
  }
});

/* Staff + Parent Email Link buttons */
sendStaffEmailLinkBtn.addEventListener("click", async ()=>{
  try { await sendEmailLink("staff"); }
  catch(e){ console.error(e); setStatus(e?.message || "Error", "err"); }
});
sendEmailLinkBtn.addEventListener("click", async ()=>{
  try { await sendEmailLink("parent"); }
  catch(e){ console.error(e); setStatus(e?.message || "Error", "err"); }
});

/* Staff actions */
saveSessionBtn.addEventListener("click", saveSettings);
addGuardianBtn.addEventListener("click", addGuardian);
addChildBtn.addEventListener("click", addChild);
linkBtn.addEventListener("click", linkParentToChild);
exportPdfBtn.addEventListener("click", ()=>exportAndArchive("pdf"));
exportCsvBtn.addEventListener("click", ()=>exportAndArchive("csv"));
clearTodayBtn.addEventListener("click", clearToday);

/* Owner actions */
inviteBtn.addEventListener("click", createStaffInviteByEmail);

/* Parent actions */
clearParentSelectionBtn.addEventListener("click", clearParentSelection);
dropOffReqBtn.addEventListener("click", ()=>createPending("DROP_OFF"));
pickUpReqBtn.addEventListener("click", ()=>createPending("PICK_UP"));

/* Boot */
async function boot(){
  updateOfflineUI();
  loadAuthIntent();

  const u = new URL(window.location.href);
  const school = (u.searchParams.get("school") || "").trim().toUpperCase();
  const mode = (u.searchParams.get("mode") || "").trim().toLowerCase();
  if(school) setSchoolCode(school);
  if(mode === "parent") setAuthIntent("parent");
  if(mode === "staff") setAuthIntent("staff");

  showRolePick();
  try { await completeEmailLinkIfPresent(); }
  catch(e){ console.error(e); setStatus(e?.message || "Error finishing email login", "err"); }

  updateRecentSchoolsUI();
}
boot();
</script>
</body>
</html>
