<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Preschool Check-In/Out</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase compat (single-file HTML) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <style>
    .bg-grid {
      background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.12) 1px, transparent 0);
      background-size: 18px 18px;
    }
    select option { color:#0f172a; background:#fff; }
    ::-webkit-scrollbar { height: 10px; width: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(100,116,139,0.35); border-radius: 999px; }
    ::-webkit-scrollbar-track { background: rgba(241,245,249,0); }
  </style>

  <script>
    tailwind.config = {
      theme: { extend: { boxShadow: { card: "0 18px 60px rgba(2,6,23,0.20)" } } }
    };
  </script>
</head>

<body class="min-h-screen text-slate-900">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-indigo-950 to-slate-900"></div>
    <div class="absolute inset-0 opacity-30 bg-grid"></div>

    <div class="absolute -top-28 -left-28 w-[520px] h-[520px] rounded-full blur-3xl opacity-25
                bg-gradient-to-br from-cyan-300 via-indigo-400 to-fuchsia-400"></div>
    <div class="absolute -bottom-40 -right-28 w-[620px] h-[620px] rounded-full blur-3xl opacity-20
                bg-gradient-to-br from-amber-300 via-rose-300 to-indigo-300"></div>

    <div class="absolute top-[30%] left-[55%] w-[380px] h-[380px] rounded-full blur-3xl opacity-15
                bg-gradient-to-br from-emerald-300 via-cyan-300 to-indigo-300"></div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-20">
    <div class="backdrop-blur-xl bg-white/10 border-b border-white/10">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-white/15 border border-white/15 flex items-center justify-center shadow-card">
            <span class="text-white text-lg">üß∏</span>
          </div>
          <div>
            <h1 class="text-white text-lg md:text-xl font-semibold tracking-tight">Check-In / Out</h1>
            <p class="text-white/70 text-xs md:text-sm" id="subTitle">Welcome</p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <span id="schoolBadge" class="hidden sm:inline text-xs px-3 py-1 rounded-full bg-white/10 border border-white/15 text-white/90"></span>
          <button id="logoutBtn"
            class="hidden px-4 py-2 rounded-xl text-sm font-semibold bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
            Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 lg:py-10">
    <!-- Offline -->
    <div id="offlineBar" class="hidden mb-4 rounded-2xl border border-amber-200/20 bg-amber-400/10 px-4 py-3 text-sm text-amber-50">
      Offline / blocked network. Use a hosted URL (not file://) and check internet.
    </div>

    <!-- Status -->
    <div id="statusWrap" class="hidden mb-5">
      <div id="statusMsg" class="rounded-2xl border px-4 py-3 text-sm"></div>
    </div>

    <!-- AUTH -->
    <section id="authShell" class="space-y-6">
      <!-- Role picker -->
      <section id="rolePickView">
        <div class="max-w-xl mx-auto rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card p-6">
          <h2 class="text-white font-semibold text-lg">Continue as</h2>
          <div class="mt-4 grid grid-cols-2 gap-3">
            <button id="pickStaffBtn" class="px-4 py-4 rounded-2xl bg-white text-slate-900 font-semibold hover:bg-slate-100 transition">
              üë©‚Äçüè´ Staff
            </button>
            <button id="pickParentBtn" class="px-4 py-4 rounded-2xl bg-indigo-500 text-white font-semibold hover:bg-indigo-600 transition">
              üë®‚Äçüë©‚Äçüëß Parent
            </button>
          </div>
        </div>
      </section>

      <section class="grid lg:grid-cols-2 gap-6">
        <!-- Staff Auth -->
        <div id="staffAuthCard" class="hidden rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card">
          <div class="p-6">
            <div class="flex items-center justify-between">
              <h2 class="text-white font-semibold text-lg">Staff</h2>
              <span class="text-xs px-3 py-1 rounded-full bg-cyan-400/10 border border-cyan-200/20 text-cyan-50">Admin</span>
            </div>

            <div class="mt-4 space-y-3">
              <input id="staffSchoolCode" autocomplete="off"
                class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                       focus:outline-none focus:ring-2 focus:ring-cyan-300/40"
                placeholder="School code"/>

              <input id="staffEmail" type="email" autocomplete="username"
                class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                       focus:outline-none focus:ring-2 focus:ring-cyan-300/40"
                placeholder="Email"/>

              <input id="staffPassword" type="password" autocomplete="current-password"
                class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                       focus:outline-none focus:ring-2 focus:ring-cyan-300/40"
                placeholder="Password"/>

              <button id="staffLoginBtn"
                class="w-full px-4 py-3 rounded-2xl bg-white text-slate-900 font-semibold hover:bg-slate-100 transition">
                Login
              </button>

              <button id="staffCreateBtn"
                class="w-full px-4 py-3 rounded-2xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                Create staff account
              </button>

              <div class="text-white/60 text-xs">
                After creating a staff account, the admin must allow-list your UID at:
                <b>schools/{code}/staff/{uid}</b>
              </div>

              <button id="backToRole1"
                class="w-full px-4 py-3 rounded-2xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                ‚Üê Back
              </button>
            </div>
          </div>
        </div>

        <!-- Parent Auth (Email Link) -->
        <div id="parentAuthCard" class="hidden rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card">
          <div class="p-6">
            <div class="flex items-center justify-between">
              <h2 class="text-white font-semibold text-lg">Parent</h2>
              <span class="text-xs px-3 py-1 rounded-full bg-indigo-400/10 border border-indigo-200/20 text-indigo-50">Email Link</span>
            </div>

            <div class="mt-4 space-y-3">
              <input id="parentSchoolCode" autocomplete="off"
                class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                       focus:outline-none focus:ring-2 focus:ring-indigo-300/40"
                placeholder="School code"/>

              <input id="parentEmail" type="email" autocomplete="email"
                class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                       focus:outline-none focus:ring-2 focus:ring-indigo-300/40"
                placeholder="Email"/>

              <button id="sendEmailLinkBtn"
                class="w-full px-4 py-3 rounded-2xl bg-indigo-500 text-white font-semibold hover:bg-indigo-600 transition">
                Send login link
              </button>

              <div class="text-white/60 text-xs">
                We‚Äôll email a secure sign-in link. Open the link to finish login.
              </div>

              <button id="backToRole2"
                class="w-full px-4 py-3 rounded-2xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                ‚Üê Back
              </button>
            </div>
          </div>
        </div>

        <!-- Email link helper (shows when user clicks link) -->
        <div id="emailLinkHint" class="hidden lg:col-span-2 rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card">
          <div class="p-6 text-white/85 text-sm">
            If you opened the email sign-in link and nothing happened, confirm your email when prompted.
          </div>
        </div>
      </section>
    </section>

    <!-- PARENT VIEW -->
    <section id="parentView" class="hidden space-y-6">
      <div class="rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card">
        <div class="p-6 md:p-7">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h2 class="text-white font-semibold text-lg">Parent</h2>
              <p id="parentHeaderInfo" class="text-white/70 text-sm"></p>
            </div>
            <div class="text-white/70 text-sm">
              <span id="parentIdentityText" class="text-white font-semibold"></span>
            </div>
          </div>

          <div class="mt-5 grid lg:grid-cols-2 gap-4">
            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="flex items-center justify-between">
                <div class="text-white/85 text-sm font-semibold">Children</div>
                <span class="text-xs px-3 py-1 rounded-full bg-white/10 border border-white/15 text-white/80">Select</span>
              </div>
              <div id="parentKidsList" class="mt-3 max-h-[360px] overflow-auto rounded-2xl border border-white/10 bg-white/5"></div>
            </div>

            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="text-white/85 text-sm font-semibold">Request</div>

              <div class="mt-4">
                <div id="pSelectedChild" class="text-white text-lg font-semibold">Select a child</div>
                <div id="pSelectedStatus" class="text-white/60 text-xs mt-1"></div>
              </div>

              <div class="mt-4">
                <input id="pNotes"
                  class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                         focus:outline-none focus:ring-2 focus:ring-indigo-300/40"
                  placeholder="Note (optional)"/>
              </div>

              <div class="mt-5 grid grid-cols-2 gap-3">
                <button id="dropOffReqBtn"
                  class="px-4 py-4 rounded-2xl bg-emerald-500 text-white font-semibold hover:bg-emerald-600 active:scale-[0.99] transition">
                  ‚úÖ Drop-off
                </button>
                <button id="pickUpReqBtn"
                  class="px-4 py-4 rounded-2xl bg-indigo-500 text-white font-semibold hover:bg-indigo-600 active:scale-[0.99] transition">
                  üéí Pick-up
                </button>
              </div>

              <button id="clearParentSelectionBtn"
                class="mt-3 w-full px-4 py-3 rounded-2xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                Clear
              </button>

              <div class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="text-white/70 text-xs">Pending</div>
                <div id="parentPendingList" class="mt-2 text-white/85 text-sm"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- STAFF VIEW -->
    <section id="staffView" class="hidden space-y-6">
      <div class="rounded-3xl bg-white/10 border border-white/10 backdrop-blur-xl shadow-card">
        <div class="p-6 md:p-7">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h2 class="text-white font-semibold text-lg">Staff</h2>
              <p class="text-white/70 text-sm">Approve ‚Ä¢ Export ‚Ä¢ Archive</p>
            </div>

            <div class="flex flex-wrap gap-2">
              <button id="exportPdfBtn"
                class="px-4 py-2 rounded-xl bg-amber-500 text-white font-semibold hover:bg-amber-600 transition">
                Export PDF & Clear
              </button>
              <button id="exportCsvBtn"
                class="px-4 py-2 rounded-xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                Export CSV & Clear
              </button>
              <button id="clearTodayBtn"
                class="px-4 py-2 rounded-xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
                Clear today
              </button>
            </div>
          </div>

          <div class="mt-6 grid lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="text-white/85 text-sm font-semibold">Header</div>
              <div class="mt-3 space-y-3">
                <input id="schoolName"
                  class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                         focus:outline-none focus:ring-2 focus:ring-cyan-300/40"
                  placeholder="School name"/>
                <input id="className"
                  class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                         focus:outline-none focus:ring-2 focus:ring-cyan-300/40"
                  placeholder="Classroom"/>
                <input id="staffName"
                  class="w-full rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                         focus:outline-none focus:ring-2 focus:ring-cyan-300/40"
                  placeholder="Staff on duty"/>

                <button id="saveSessionBtn"
                  class="w-full px-4 py-3 rounded-2xl bg-white text-slate-900 font-semibold hover:bg-slate-100 transition">
                  Save
                </button>
              </div>
            </div>

            <div class="lg:col-span-4 rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="text-white/85 text-sm font-semibold">Parents</div>
              <div class="mt-3 grid gap-3">
                <input id="newGuardianName"
                  class="rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                         focus:outline-none focus:ring-2 focus:ring-indigo-300/40"
                  placeholder="Parent name"/>
                <input id="newGuardianEmail" type="email" autocomplete="email"
                  class="rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                         focus:outline-none focus:ring-2 focus:ring-indigo-300/40"
                  placeholder="Parent email"/>
                <button id="addGuardianBtn"
                  class="px-4 py-3 rounded-2xl bg-indigo-500 text-white font-semibold hover:bg-indigo-600 transition">
                  Add
                </button>
              </div>
              <div id="guardianList" class="mt-4 max-h-[220px] overflow-auto rounded-2xl border border-white/10 bg-white/5"></div>
            </div>

            <div class="lg:col-span-4 rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="text-white/85 text-sm font-semibold">Children</div>
              <div class="mt-3 grid gap-3">
                <input id="newChildName"
                  class="rounded-2xl border border-white/15 bg-white/10 text-white placeholder:text-white/40 px-4 py-3
                         focus:outline-none focus:ring-2 focus:ring-emerald-300/40"
                  placeholder="Child name"/>
                <button id="addChildBtn"
                  class="px-4 py-3 rounded-2xl bg-emerald-500 text-white font-semibold hover:bg-emerald-600 transition">
                  Add
                </button>
              </div>
              <div id="childAdminList" class="mt-4 max-h-[220px] overflow-auto rounded-2xl border border-white/10 bg-white/5"></div>
            </div>
          </div>

          <div class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="text-white/85 text-sm font-semibold">Link (max 2 parents)</div>
            <div class="mt-4 grid md:grid-cols-3 gap-3">
              <select id="linkChildSelect"
                class="rounded-2xl border border-white/15 bg-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-300/40">
                <option value="">Child</option>
              </select>
              <select id="linkGuardianSelect"
                class="rounded-2xl border border-white/15 bg-white/10 text-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-300/40">
                <option value="">Parent</option>
              </select>
              <button id="linkBtn"
                class="px-4 py-3 rounded-2xl bg-white text-slate-900 font-semibold hover:bg-slate-100 transition">
                Link
              </button>
            </div>
            <div id="linkSummary" class="mt-4 text-white/70 text-sm"></div>
          </div>

          <div class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center justify-between">
              <div class="text-white/85 text-sm font-semibold">Pending</div>
              <span id="pendingCount" class="text-xs px-3 py-1 rounded-full bg-white/10 border border-white/15 text-white/80"></span>
            </div>
            <div id="pendingList" class="mt-4 max-h-[320px] overflow-auto rounded-2xl border border-white/10 bg-white/5"></div>
          </div>

          <div class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center justify-between">
              <div class="text-white/85 text-sm font-semibold">Today</div>
              <div class="text-white/60 text-xs" id="logCount"></div>
            </div>
            <div class="mt-4 overflow-auto rounded-2xl border border-white/10 bg-white/5">
              <table class="min-w-full text-sm">
                <thead class="sticky top-0 bg-slate-950/60 backdrop-blur border-b border-white/10">
                  <tr class="text-white/90">
                    <th class="text-left px-4 py-3 font-semibold">Parent</th>
                    <th class="text-left px-4 py-3 font-semibold">Staff</th>
                    <th class="text-left px-4 py-3 font-semibold">Action</th>
                    <th class="text-left px-4 py-3 font-semibold">Child</th>
                    <th class="text-left px-4 py-3 font-semibold">Email</th>
                    <th class="text-left px-4 py-3 font-semibold">Note</th>
                  </tr>
                </thead>
                <tbody id="logTbody" class="divide-y divide-white/5 text-white/85"></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <!-- Parent confirm modal -->
  <div id="parentConfirmModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-lg rounded-3xl bg-white text-slate-900 shadow-2xl">
        <div class="p-5 md:p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Confirm</h3>
            <button id="pModalCloseBtn" class="px-3 py-2 rounded-xl hover:bg-slate-100">‚úï</button>
          </div>

          <div class="mt-4 rounded-2xl border bg-slate-50 p-4">
            <div class="text-sm text-slate-600">Action</div>
            <div id="pMAction" class="text-lg font-semibold"></div>

            <div class="mt-3 grid grid-cols-2 gap-3">
              <div><div class="text-sm text-slate-600">Child</div><div id="pMChild" class="font-semibold"></div></div>
              <div><div class="text-sm text-slate-600">Email</div><div id="pMEmail" class="font-semibold"></div></div>
            </div>

            <div class="mt-3">
              <div class="text-sm text-slate-600">Time</div>
              <div id="pMTime" class="font-semibold"></div>
            </div>

            <div class="mt-3">
              <div class="text-sm text-slate-600">Note</div>
              <div id="pMNotes" class="text-slate-800"></div>
            </div>
          </div>

          <div class="mt-5 grid grid-cols-2 gap-3">
            <button id="pModalCancelBtn" class="px-4 py-3 rounded-2xl bg-slate-100 font-semibold hover:bg-slate-200">Cancel</button>
            <button id="pModalConfirmBtn" class="px-4 py-3 rounded-2xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Staff approve modal -->
  <div id="staffApproveModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-lg rounded-3xl bg-white text-slate-900 shadow-2xl">
        <div class="p-5 md:p-6">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Approve</h3>
            <button id="sModalCloseBtn" class="px-3 py-2 rounded-xl hover:bg-slate-100">‚úï</button>
          </div>

          <div class="mt-4 rounded-2xl border bg-slate-50 p-4">
            <div class="text-sm text-slate-600">Action</div>
            <div id="sMAction" class="text-lg font-semibold"></div>

            <div class="mt-3 grid grid-cols-2 gap-3">
              <div><div class="text-sm text-slate-600">Child</div><div id="sMChild" class="font-semibold"></div></div>
              <div><div class="text-sm text-slate-600">Email</div><div id="sMEmail" class="font-semibold"></div></div>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-3">
              <div><div class="text-sm text-slate-600">Parent</div><div id="sMReqTime" class="font-semibold"></div></div>
              <div><div class="text-sm text-slate-600">Staff</div><div id="sMConfTime" class="font-semibold"></div></div>
            </div>

            <div class="mt-3">
              <div class="text-sm text-slate-600">Note</div>
              <div id="sMNotes" class="text-slate-800"></div>
            </div>
          </div>

          <div class="mt-5 grid grid-cols-2 gap-3">
            <button id="sModalRejectBtn" class="px-4 py-3 rounded-2xl bg-rose-100 text-rose-700 font-semibold hover:bg-rose-200">Reject</button>
            <button id="sModalApproveBtn" class="px-4 py-3 rounded-2xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Approve</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================= Firebase init =================
   NOTE: Firebase "apiKey" is not a secret, but GitHub flags it.
   In Google Cloud Console, restrict this key to your domain if desired. */
const firebaseConfig = {
  apiKey: "AIzaSyC0vDzgPZllUU_gYU0iIYPiT4OWbj-eYHQ",
  authDomain: "preschool-a9bb0.firebaseapp.com",
  projectId: "preschool-a9bb0",
  storageBucket: "preschool-a9bb0.firebasestorage.app",
  messagingSenderId: "462699240938",
  appId: "1:462699240938:web:fad34d16574a062ce42693",
  measurementId: "G-PEL1T3XE2B"
};
firebase.initializeApp(firebaseConfig);
try { firebase.analytics(); } catch(e) {}

const AUTH = firebase.auth();
const DB   = firebase.firestore();
DB.enableNetwork().catch(()=>{});

/* ================= Helpers ================= */
const pad2 = n => String(n).padStart(2,"0");
const todayKey = () => { const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
const nowLocal = () => { const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`; };
const esc = s => String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
const escA = s => esc(s).replaceAll("\n"," ");
const normalizeEmail = s => String(s||"").trim().toLowerCase();
const makeId = p => p + "_" + Math.random().toString(16).slice(2) + Date.now().toString(16);

function setStatus(msg, type="info") {
  statusWrap.classList.remove("hidden");
  const base = "rounded-2xl border px-4 py-3 text-sm";
  const styles = {
    ok:  "bg-emerald-400/10 border-emerald-200/20 text-emerald-50",
    err: "bg-rose-400/10 border-rose-200/20 text-rose-50",
    info:"bg-white/10 border-white/15 text-white/90"
  };
  statusMsg.className = `${base} ${styles[type] || styles.info}`;
  statusMsg.textContent = msg;
}

function updateOfflineUI(){
  offlineBar.classList.toggle("hidden", navigator.onLine);
}
window.addEventListener("online", updateOfflineUI);
window.addEventListener("offline", updateOfflineUI);

function safeSetInput(el, value){
  if(document.activeElement === el) return;
  el.value = value ?? "";
}

/* ================= DOM ================= */
const subTitle = document.getElementById("subTitle");
const logoutBtn = document.getElementById("logoutBtn");
const offlineBar = document.getElementById("offlineBar");
const schoolBadge = document.getElementById("schoolBadge");

const statusWrap = document.getElementById("statusWrap");
const statusMsg  = document.getElementById("statusMsg");

const rolePickView = document.getElementById("rolePickView");
const pickStaffBtn = document.getElementById("pickStaffBtn");
const pickParentBtn = document.getElementById("pickParentBtn");

const staffAuthCard = document.getElementById("staffAuthCard");
const parentAuthCard = document.getElementById("parentAuthCard");
const emailLinkHint = document.getElementById("emailLinkHint");

const backToRole1 = document.getElementById("backToRole1");
const backToRole2 = document.getElementById("backToRole2");

const staffView  = document.getElementById("staffView");
const parentView = document.getElementById("parentView");

/* Auth - Staff */
const staffSchoolCode = document.getElementById("staffSchoolCode");
const staffEmail = document.getElementById("staffEmail");
const staffPassword = document.getElementById("staffPassword");
const staffLoginBtn = document.getElementById("staffLoginBtn");
const staffCreateBtn = document.getElementById("staffCreateBtn");

/* Auth - Parent */
const parentSchoolCode = document.getElementById("parentSchoolCode");
const parentEmail = document.getElementById("parentEmail");
const sendEmailLinkBtn = document.getElementById("sendEmailLinkBtn");

/* Parent */
const parentHeaderInfo = document.getElementById("parentHeaderInfo");
const parentIdentityText = document.getElementById("parentIdentityText");
const parentKidsList = document.getElementById("parentKidsList");
const parentPendingList = document.getElementById("parentPendingList");
const pSelectedChild = document.getElementById("pSelectedChild");
const pSelectedStatus = document.getElementById("pSelectedStatus");
const pNotes = document.getElementById("pNotes");
const dropOffReqBtn = document.getElementById("dropOffReqBtn");
const pickUpReqBtn  = document.getElementById("pickUpReqBtn");
const clearParentSelectionBtn = document.getElementById("clearParentSelectionBtn");

/* Staff */
const schoolName = document.getElementById("schoolName");
const className  = document.getElementById("className");
const staffName  = document.getElementById("staffName");
const saveSessionBtn = document.getElementById("saveSessionBtn");
const clearTodayBtn  = document.getElementById("clearTodayBtn");
const exportPdfBtn = document.getElementById("exportPdfBtn");
const exportCsvBtn = document.getElementById("exportCsvBtn");

const newGuardianName = document.getElementById("newGuardianName");
const newGuardianEmail = document.getElementById("newGuardianEmail");
const addGuardianBtn  = document.getElementById("addGuardianBtn");
const guardianList    = document.getElementById("guardianList");

const newChildName = document.getElementById("newChildName");
const addChildBtn  = document.getElementById("addChildBtn");
const childAdminList = document.getElementById("childAdminList");

const linkChildSelect = document.getElementById("linkChildSelect");
const linkGuardianSelect = document.getElementById("linkGuardianSelect");
const linkBtn = document.getElementById("linkBtn");
const linkSummary = document.getElementById("linkSummary");

const pendingCount = document.getElementById("pendingCount");
const pendingList  = document.getElementById("pendingList");

const logCount = document.getElementById("logCount");
const logTbody = document.getElementById("logTbody");

/* Modals */
const parentConfirmModal = document.getElementById("parentConfirmModal");
const pModalCloseBtn = document.getElementById("pModalCloseBtn");
const pModalCancelBtn = document.getElementById("pModalCancelBtn");
const pModalConfirmBtn = document.getElementById("pModalConfirmBtn");
const pMAction = document.getElementById("pMAction");
const pMChild = document.getElementById("pMChild");
const pMEmail = document.getElementById("pMEmail");
const pMTime = document.getElementById("pMTime");
const pMNotes = document.getElementById("pMNotes");

const staffApproveModal = document.getElementById("staffApproveModal");
const sModalCloseBtn = document.getElementById("sModalCloseBtn");
const sModalRejectBtn = document.getElementById("sModalRejectBtn");
const sModalApproveBtn = document.getElementById("sModalApproveBtn");
const sMAction = document.getElementById("sMAction");
const sMChild = document.getElementById("sMChild");
const sMEmail = document.getElementById("sMEmail");
const sMReqTime = document.getElementById("sMReqTime");
const sMConfTime = document.getElementById("sMConfTime");
const sMNotes = document.getElementById("sMNotes");

/* ================= App state ================= */
const LS_SCHOOL = "PRESCHOOL_SCHOOL_CODE";
const LS_PARENT_EMAIL = "PRESCHOOL_PARENT_EMAIL_FOR_LINK";

let APP = {
  schoolCode: null,
  role: null,              // "staff" | "parent"
  user: null,

  settings: { schoolName:"", className:"", staffName:"" },
  guardians: [],
  children: [],
  pending: [],
  logs: [],

  selectedChildId: null,
  parentPendingAction: null,
  staffSelectedPendingId: null,

  unsub: []
};

/* ================= Views ================= */
function showRolePick() {
  rolePickView.classList.remove("hidden");
  staffAuthCard.classList.add("hidden");
  parentAuthCard.classList.add("hidden");
  staffView.classList.add("hidden");
  parentView.classList.add("hidden");
  logoutBtn.classList.add("hidden");
  subTitle.textContent = "Welcome";
}
function showStaffAuth() {
  rolePickView.classList.add("hidden");
  staffAuthCard.classList.remove("hidden");
  parentAuthCard.classList.add("hidden");
  staffView.classList.add("hidden");
  parentView.classList.add("hidden");
  logoutBtn.classList.add("hidden");
  subTitle.textContent = "Staff login";
}
function showParentAuth() {
  rolePickView.classList.add("hidden");
  staffAuthCard.classList.add("hidden");
  parentAuthCard.classList.remove("hidden");
  staffView.classList.add("hidden");
  parentView.classList.add("hidden");
  logoutBtn.classList.add("hidden");
  subTitle.textContent = "Parent login";
}
function showStaff() {
  rolePickView.classList.add("hidden");
  staffAuthCard.classList.add("hidden");
  parentAuthCard.classList.add("hidden");
  staffView.classList.remove("hidden");
  parentView.classList.add("hidden");
  logoutBtn.classList.remove("hidden");
  subTitle.textContent = "Staff";
}
function showParent() {
  rolePickView.classList.add("hidden");
  staffAuthCard.classList.add("hidden");
  parentAuthCard.classList.add("hidden");
  staffView.classList.add("hidden");
  parentView.classList.remove("hidden");
  logoutBtn.classList.remove("hidden");
  subTitle.textContent = "Parent";
}

function stopListeners(){
  APP.unsub.forEach(fn=>{ try{ fn(); }catch{} });
  APP.unsub = [];
}

function setSchoolCode(code){
  const c = String(code||"").trim().toUpperCase();
  APP.schoolCode = c || null;
  if(APP.schoolCode){
    localStorage.setItem(LS_SCHOOL, APP.schoolCode);
    schoolBadge.textContent = `School: ${APP.schoolCode}`;
    schoolBadge.classList.remove("hidden");
  } else {
    schoolBadge.classList.add("hidden");
  }
}

function schoolRef(){
  if(!APP.schoolCode) throw new Error("Missing schoolCode");
  return DB.collection("schools").doc(APP.schoolCode);
}

/* ================= Security routing: staff allow-list ================= */
async function isStaffAllowListed(uid){
  const doc = await schoolRef().collection("staff").doc(uid).get();
  return doc.exists;
}

/* ================= Firestore sync (no composite-index queries) ================= */
function onSnapError(err){
  console.error(err);
  const msg = String(err?.message||"Error");
  if(msg.toLowerCase().includes("offline")){
    updateOfflineUI();
    setStatus("Offline / blocked network.", "err");
  } else {
    setStatus(msg, "err");
  }
}

function bindSchoolDataForStaff(){
  stopListeners();
  const sref = schoolRef();

  APP.unsub.push(
    sref.collection("settings").doc("main").onSnapshot((doc)=>{
      APP.settings = doc.exists ? doc.data() : { schoolName:"", className:"", staffName:"" };
      safeSetInput(schoolName, APP.settings.schoolName || "");
      safeSetInput(className, APP.settings.className || "");
      safeSetInput(staffName, APP.settings.staffName || "");
      renderParentHeader(); // keeps header consistent if you switch roles on same device
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("guardians").onSnapshot((snap)=>{
      APP.guardians = snap.docs.map(d=>({ id:d.id, ...d.data() }))
        .sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
      renderGuardianList();
      renderLinkDropdowns();
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("children").onSnapshot((snap)=>{
      APP.children = snap.docs.map(d=>({ id:d.id, ...d.data() }))
        .sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
      renderChildAdminList();
      renderLinkDropdowns();
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("pending").onSnapshot((snap)=>{
      APP.pending = snap.docs.map(d=>({ id:d.id, ...d.data() }))
        .sort((a,b)=> (b.requestedAtTs?.toMillis?.()||0) - (a.requestedAtTs?.toMillis?.()||0) );
      renderPending();
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("logs").where("date","==", todayKey()).onSnapshot((snap)=>{
      APP.logs = snap.docs.map(d=>({ id:d.id, ...d.data() }))
        .sort((a,b)=> (b.staffTimeTs?.toMillis?.()||0) - (a.staffTimeTs?.toMillis?.()||0) );
      renderLogs();
    }, onSnapError)
  );
}

function bindSchoolDataForParent(){
  stopListeners();
  const sref = schoolRef();
  const email = normalizeEmail(AUTH.currentUser?.email);
  if(!email) return;

  APP.unsub.push(
    sref.collection("settings").doc("main").onSnapshot((doc)=>{
      APP.settings = doc.exists ? doc.data() : { schoolName:"", className:"", staffName:"" };
      renderParentHeader();
    }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("children")
      .where("guardianEmails","array-contains", email)
      .onSnapshot((snap)=>{
        APP.children = snap.docs.map(d=>({ id:d.id, ...d.data() }))
          .sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
        renderParentKids();
      }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("pending")
      .where("guardianEmail","==", email)
      .onSnapshot((snap)=>{
        APP.pending = snap.docs.map(d=>({ id:d.id, ...d.data() }))
          .sort((a,b)=> (b.requestedAtTs?.toMillis?.()||0) - (a.requestedAtTs?.toMillis?.()||0) );
        renderParentPending();
      }, onSnapError)
  );

  APP.unsub.push(
    sref.collection("logs")
      .where("date","==", todayKey())
      .where("guardianEmail","==", email)
      .onSnapshot((snap)=>{
        APP.logs = snap.docs.map(d=>({ id:d.id, ...d.data() }))
          .sort((a,b)=> (b.staffTimeTs?.toMillis?.()||0) - (a.staffTimeTs?.toMillis?.()||0) );
        renderParentKids();
      }, onSnapError)
  );
}

/* ================= Render (Parent) ================= */
function renderParentHeader(){
  const parts = [APP.settings.schoolName, APP.settings.className].filter(Boolean);
  parentHeaderInfo.textContent = parts.join(" ‚Ä¢ ");
  parentIdentityText.textContent = AUTH.currentUser?.email || "";
}

function latestActionForChild(childId){
  const last = APP.logs.find(l => l.childId === childId);
  return last ? last.action : null;
}

function clearParentSelection(){
  APP.selectedChildId = null;
  pSelectedChild.textContent = "Select a child";
  pSelectedStatus.textContent = "";
  pNotes.value = "";
}

function renderParentKids(){
  const kids = (APP.children||[]);
  if(!kids.length){
    parentKidsList.innerHTML = `<div class="p-4 text-white/60 text-sm">No linked children.</div>`;
    clearParentSelection();
    return;
  }
  parentKidsList.innerHTML = kids.map(c=>{
    const st = latestActionForChild(c.id);
    const pill = st==="DROP_OFF" ? "bg-emerald-400/10 border-emerald-200/20 text-emerald-50"
                                : "bg-indigo-400/10 border-indigo-200/20 text-indigo-50";
    return `
      <button data-kid="${escA(c.id)}" class="w-full text-left p-4 flex items-center justify-between gap-3 hover:bg-white/5 transition">
        <div class="text-white font-semibold">${esc(c.name||"")}</div>
        ${st ? `<span class="text-xs px-3 py-1 rounded-full border ${pill}">${st==="DROP_OFF"?"IN":"OUT"}</span>` : ``}
      </button>
    `;
  }).join("");

  [...parentKidsList.querySelectorAll("button[data-kid]")].forEach(btn=>{
    btn.addEventListener("click", ()=>{
      APP.selectedChildId = btn.getAttribute("data-kid");
      const child = APP.children.find(c=>c.id===APP.selectedChildId);
      pSelectedChild.textContent = child?.name || "Select a child";
      const st = latestActionForChild(APP.selectedChildId);
      pSelectedStatus.textContent = st ? `Status: ${st==="DROP_OFF"?"IN":"OUT"}` : "";
      setStatus("Selected.", "ok");
    });
  });

  renderParentPending();
}

function renderParentPending(){
  const list = (APP.pending||[]).slice(0,8);
  parentPendingList.innerHTML = list.length
    ? list.map(p=>`<div class="text-white/85">‚Ä¢ ${esc(p.childName||"")} ‚Äî ${p.action==="DROP_OFF"?"Drop-off":"Pick-up"} (waiting)</div>`).join("")
    : "None";
}

/* ================= Render (Staff) ================= */
function renderGuardianList(){
  const gs = (APP.guardians||[]);
  if(!gs.length){
    guardianList.innerHTML = `<div class="p-4 text-white/60 text-sm">No parents</div>`;
    return;
  }
  guardianList.innerHTML = gs.map(g=>`
    <div class="p-3 border-b border-white/5 flex items-center justify-between gap-3">
      <div>
        <div class="text-white font-semibold">${esc(g.name||"")}</div>
        <div class="text-white/60 text-xs">${esc(g.email||"")}</div>
      </div>
      <button data-delg="${escA(g.id)}"
        class="text-xs px-3 py-2 rounded-xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
        Remove
      </button>
    </div>
  `).join("");

  [...guardianList.querySelectorAll("button[data-delg]")].forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-delg");
      if(!confirm("Remove parent?")) return;
      await schoolRef().collection("guardians").doc(id).delete();
      setStatus("Removed.", "info");
    });
  });
}

function renderChildAdminList(){
  const cs = (APP.children||[]);
  if(!cs.length){
    childAdminList.innerHTML = `<div class="p-4 text-white/60 text-sm">No children</div>`;
    return;
  }
  childAdminList.innerHTML = cs.map(c=>{
    const emails = (c.guardianEmails||[]).filter(Boolean);
    return `
      <div class="p-3 border-b border-white/5 flex items-start justify-between gap-3">
        <div>
          <div class="text-white font-semibold">${esc(c.name||"")}</div>
          <div class="text-white/60 text-xs mt-1">
            ${emails.length ? emails.map(e=>`‚Ä¢ ${esc(e)}`).join("<br/>") : "No linked parents"}
          </div>
        </div>
        <button data-delc="${escA(c.id)}"
          class="text-xs px-3 py-2 rounded-xl bg-white/10 border border-white/15 text-white hover:bg-white/15 transition">
          Remove
        </button>
      </div>
    `;
  }).join("");

  [...childAdminList.querySelectorAll("button[data-delc]")].forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-delc");
      if(!confirm("Remove child?")) return;
      await schoolRef().collection("children").doc(id).delete();
      setStatus("Removed.", "info");
    });
  });
}

function renderLinkDropdowns(){
  linkChildSelect.innerHTML = `<option value="">Child</option>` +
    (APP.children||[]).map(c=>`<option value="${escA(c.id)}">${esc(c.name||"")}</option>`).join("");

  linkGuardianSelect.innerHTML = `<option value="">Parent</option>` +
    (APP.guardians||[]).map(g=>`<option value="${escA(g.id)}">${esc(g.name||"")} (${esc(g.email||"")})</option>`).join("");

  linkSummary.textContent = `${(APP.children||[]).length} children ‚Ä¢ ${(APP.guardians||[]).length} parents ‚Ä¢ max 2`;
}

function renderPending(){
  pendingCount.textContent = `${(APP.pending||[]).length} pending`;
  const list = (APP.pending||[]);
  if(!list.length){
    pendingList.innerHTML = `<div class="p-4 text-white/60 text-sm">None</div>`;
    return;
  }
  pendingList.innerHTML = list.map(p=>{
    const pill = p.action==="DROP_OFF" ? "bg-emerald-400/10 border-emerald-200/20 text-emerald-50"
                                      : "bg-indigo-400/10 border-indigo-200/20 text-indigo-50";
    return `
      <div class="p-4 border-b border-white/5 flex items-start justify-between gap-3">
        <div>
          <div class="text-white font-semibold">${esc(p.childName||"")}</div>
          <div class="mt-1 text-white/70 text-sm">
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs border ${pill}">
              ${p.action==="DROP_OFF"?"Drop-off":"Pick-up"}
            </span>
            <span class="ml-2">${esc(p.guardianEmail||"")}</span>
          </div>
          <div class="mt-1 text-white/60 text-xs">Parent: ${esc(p.requestedAt||"")}</div>
        </div>
        <button data-approve="${escA(p.id)}"
          class="px-4 py-2 rounded-xl bg-white text-slate-900 font-semibold hover:bg-slate-100 transition">
          Review
        </button>
      </div>
    `;
  }).join("");

  [...pendingList.querySelectorAll("button[data-approve]")].forEach(btn=>{
    btn.addEventListener("click", ()=>openStaffApproveModal(btn.getAttribute("data-approve")));
  });
}

function renderLogs(){
  const rows = (APP.logs||[]);
  logCount.textContent = `${rows.length} entries`;
  if(!rows.length){
    logTbody.innerHTML = `<tr><td class="px-4 py-6 text-white/60" colspan="6">No entries yet.</td></tr>`;
    return;
  }
  logTbody.innerHTML = rows.map(r=>{
    const pill = r.action==="DROP_OFF" ? "bg-emerald-400/10 border-emerald-200/20 text-emerald-50"
                                      : "bg-indigo-400/10 border-indigo-200/20 text-indigo-50";
    return `
      <tr class="hover:bg-white/5 transition">
        <td class="px-4 py-3 whitespace-nowrap">${esc(r.parentTime||"")}</td>
        <td class="px-4 py-3 whitespace-nowrap">${esc(r.staffTime||"")}</td>
        <td class="px-4 py-3">
          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs border ${pill}">
            ${r.action==="DROP_OFF"?"Drop-off":"Pick-up"}
          </span>
        </td>
        <td class="px-4 py-3">${esc(r.childName||"")}</td>
        <td class="px-4 py-3">${esc(r.guardianEmail||"")}</td>
        <td class="px-4 py-3 max-w-[260px] truncate" title="${escA(r.notes||"")}">${esc(r.notes||"")}</td>
      </tr>
    `;
  }).join("");
}

/* ================= Parent request flow ================= */
function openParentConfirmModal(action){
  if(APP.role!=="parent") return setStatus("Login as parent.", "err");
  if(!APP.selectedChildId) return setStatus("Select a child.", "err");

  const child = APP.children.find(c=>c.id===APP.selectedChildId);
  if(!child) return setStatus("Missing child.", "err");

  const alreadyPending = (APP.pending||[]).some(p => p.childId===child.id && p.action===action);
  if(alreadyPending) return setStatus("Already pending.", "err");

  const last = (APP.logs||[]).find(l => l.childId===child.id);
  if(last && last.action===action) return setStatus("Already recorded.", "err");

  APP.parentPendingAction = action;
  pMAction.textContent = action==="DROP_OFF" ? "Drop-off" : "Pick-up";
  pMChild.textContent = child.name || "";
  pMEmail.textContent = normalizeEmail(AUTH.currentUser?.email) || "";
  pMTime.textContent = nowLocal();
  pMNotes.textContent = (pNotes.value||"").trim() || "-";
  parentConfirmModal.classList.remove("hidden");
}
function closeParentModal(){
  parentConfirmModal.classList.add("hidden");
  APP.parentPendingAction = null;
}
async function commitPending(){
  const action = APP.parentPendingAction;
  if(!action) return;

  const email = normalizeEmail(AUTH.currentUser?.email);
  const child = APP.children.find(c=>c.id===APP.selectedChildId);
  if(!child || !email) return;

  await schoolRef().collection("pending").add({
    date: todayKey(),
    action,
    schoolCode: APP.schoolCode,
    childId: child.id,
    childName: child.name || "",
    guardianEmail: email,
    notes: (pNotes.value||"").trim(),
    requestedAt: nowLocal(),
    requestedAtTs: firebase.firestore.FieldValue.serverTimestamp()
  });

  pNotes.value = "";
  closeParentModal();
  setStatus("Sent to staff.", "ok");
}

/* ================= Staff approve flow ================= */
function openStaffApproveModal(pendingId){
  const req = (APP.pending||[]).find(p=>p.id===pendingId);
  if(!req) return;
  APP.staffSelectedPendingId = pendingId;

  sMAction.textContent = req.action==="DROP_OFF" ? "Drop-off" : "Pick-up";
  sMChild.textContent = req.childName || "";
  sMEmail.textContent = req.guardianEmail || "";
  sMReqTime.textContent = req.requestedAt || "";
  sMConfTime.textContent = nowLocal();
  sMNotes.textContent = req.notes || "-";
  staffApproveModal.classList.remove("hidden");
}
function closeStaffModal(){
  staffApproveModal.classList.add("hidden");
  APP.staffSelectedPendingId = null;
}
async function staffReject(){
  if(!APP.staffSelectedPendingId) return;
  await schoolRef().collection("pending").doc(APP.staffSelectedPendingId).delete();
  closeStaffModal();
  setStatus("Rejected.", "info");
}
async function staffApprove(){
  if(!APP.staffSelectedPendingId) return;
  if(!String(staffName.value||"").trim()) return setStatus("Enter staff name.", "err");

  const reqSnap = await schoolRef().collection("pending").doc(APP.staffSelectedPendingId).get();
  if(!reqSnap.exists) return setStatus("Pending not found.", "err");
  const req = reqSnap.data();

  const batch = DB.batch();
  const logRef = schoolRef().collection("logs").doc();
  batch.set(logRef, {
    date: todayKey(),
    action: req.action,
    childId: req.childId,
    childName: req.childName,
    guardianEmail: req.guardianEmail,
    notes: req.notes || "",
    parentTime: req.requestedAt,
    staffTime: nowLocal(),
    staffName: String(staffName.value||"").trim(),
    staffTimeTs: firebase.firestore.FieldValue.serverTimestamp()
  });
  batch.delete(schoolRef().collection("pending").doc(APP.staffSelectedPendingId));
  await batch.commit();

  closeStaffModal();
  setStatus("Approved.", "ok");
}

/* ================= Staff CRUD ================= */
async function saveSettings(){
  await schoolRef().collection("settings").doc("main").set({
    schoolName: (schoolName.value||"").trim(),
    className:  (className.value||"").trim(),
    staffName:  (staffName.value||"").trim()
  }, { merge:true });
  setStatus("Saved.", "ok");
}

async function addGuardian(){
  const name = (newGuardianName.value||"").trim();
  const email = normalizeEmail(newGuardianEmail.value||"");
  if(!name) return setStatus("Enter name.", "err");
  if(!email || !email.includes("@")) return setStatus("Enter valid email.", "err");

  const existing = await schoolRef().collection("guardians").where("email","==",email).limit(1).get();
  if(!existing.empty) return setStatus("Email exists.", "err");

  await schoolRef().collection("guardians").add({
    name, email,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  newGuardianName.value = "";
  newGuardianEmail.value = "";
  setStatus("Added.", "ok");
}

async function addChild(){
  const name = (newChildName.value||"").trim();
  if(!name) return setStatus("Enter child name.", "err");
  await schoolRef().collection("children").add({
    name,
    guardianEmails: [],
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  newChildName.value = "";
  setStatus("Added.", "ok");
}

async function linkParentToChild(){
  const childId = linkChildSelect.value;
  const guardianId = linkGuardianSelect.value;
  if(!childId || !guardianId) return setStatus("Select both.", "err");

  const g = APP.guardians.find(x=>x.id===guardianId);
  if(!g) return setStatus("Parent missing.", "err");

  const cRef = schoolRef().collection("children").doc(childId);
  const cSnap = await cRef.get();
  if(!cSnap.exists) return setStatus("Child missing.", "err");
  const c = cSnap.data();

  const emails = Array.isArray(c.guardianEmails) ? c.guardianEmails.slice() : [];
  if(emails.includes(g.email)) return setStatus("Already linked.", "info");
  if(emails.length >= 2) return setStatus("Max 2 parents.", "err");

  emails.push(g.email);
  await cRef.set({ guardianEmails: emails }, { merge:true });

  setStatus("Linked.", "ok");
}

/* ================= Export + archive + clear ================= */
async function exportAndArchive(kind){
  if(APP.role!=="staff") return setStatus("Staff only.", "err");
  if(!APP.logs.length) return setStatus("No logs.", "err");

  const sref = schoolRef();
  const date = todayKey();

  if(kind==="csv"){
    const headers = ["date","parentTime","staffTime","action","childName","guardianEmail","notes","staffName","schoolName","className"];
    const csvEscape = v => `"${String(v ?? "").replaceAll('"','""')}"`;
    const rows = APP.logs.slice().reverse().map(r => headers.map(h => csvEscape(
      h==="schoolName" ? (APP.settings.schoolName||"") :
      h==="className" ? (APP.settings.className||"") :
      r[h]
    )));
    const csv = [headers.join(","), ...rows.map(r=>r.join(","))].join("\n");
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download=`daily_log_${date}.csv`; a.click();
    URL.revokeObjectURL(url);
  }

  if(kind==="pdf"){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"letter" });
    const margin=40; let y=52;

    doc.setFont("helvetica","bold"); doc.setFontSize(16);
    doc.text(`${APP.settings.schoolName || "School"} ‚Äî Daily Log`, margin, y);

    doc.setFont("helvetica","normal"); doc.setFontSize(11);
    y+=20; doc.text(`Date: ${date}    Class: ${APP.settings.className || ""}`, margin, y);
    y+=16; doc.text(`Staff: ${(APP.settings.staffName || staffName.value || "").trim()}    Generated: ${nowLocal()}`, margin, y);
    y+=18;

    const body = APP.logs.slice().reverse().map(r => ([
      r.parentTime, r.staffTime,
      r.action==="DROP_OFF" ? "Drop-off" : "Pick-up",
      r.childName,
      r.guardianEmail,
      (r.notes||"").slice(0,90),
    ]));

    doc.autoTable({
      startY: y,
      head: [["Parent","Staff","Action","Child","Email","Note"]],
      body,
      theme: "grid",
      styles: { font:"helvetica", fontSize: 9, cellPadding: 4, overflow:"linebreak" },
      headStyles: { fillColor: [20,20,20], textColor: 255 },
      margin: { left: margin, right: margin }
    });

    doc.save(`daily_log_${date}.pdf`);
  }

  await sref.collection("archives").doc(date).set({
    date,
    exportedAt: nowLocal(),
    header: { ...APP.settings, staffName: (APP.settings.staffName || staffName.value || "").trim() },
    logs: APP.logs.slice().reverse()
  }, { merge:true });

  // clear today's pending + logs
  const batch = DB.batch();
  const pendSnap = await sref.collection("pending").get();
  pendSnap.forEach(d=>batch.delete(d.ref));

  const logsSnap = await sref.collection("logs").where("date","==",date).get();
  logsSnap.forEach(d=>batch.delete(d.ref));

  await batch.commit();
  setStatus("Exported + cleared.", "ok");
}

async function clearToday(){
  if(APP.role!=="staff") return setStatus("Staff only.", "err");
  if(!confirm("Clear today?")) return;

  const sref = schoolRef();
  const date = todayKey();

  const batch = DB.batch();
  const pendSnap = await sref.collection("pending").get();
  pendSnap.forEach(d=>batch.delete(d.ref));

  const logsSnap = await sref.collection("logs").where("date","==",date).get();
  logsSnap.forEach(d=>batch.delete(d.ref));

  await batch.commit();
  setStatus("Cleared.", "ok");
}

/* ================= Email Link Auth (Parent) ================= */
async function sendParentEmailLink(){
  const code = (parentSchoolCode.value||"").trim().toUpperCase();
  const email = normalizeEmail(parentEmail.value||"");
  if(!code) return setStatus("Enter school code.", "err");
  if(!email || !email.includes("@")) return setStatus("Enter valid email.", "err");

  setSchoolCode(code);

  // Put school in the return URL so parent can login from any device
  const url = `${location.origin}${location.pathname}?mode=parent&school=${encodeURIComponent(code)}`;

  const actionCodeSettings = { url, handleCodeInApp: true };
  await AUTH.sendSignInLinkToEmail(email, actionCodeSettings);

  localStorage.setItem(LS_PARENT_EMAIL, email);
  emailLinkHint.classList.remove("hidden");
  setStatus("Login link sent. Check your email.", "ok");
}

async function completeEmailLinkIfPresent(){
  if(!AUTH.isSignInWithEmailLink(window.location.href)) return;

  emailLinkHint.classList.remove("hidden");

  const u = new URL(window.location.href);
  const school = (u.searchParams.get("school") || "").trim().toUpperCase();
  if(school) setSchoolCode(school);

  let email = localStorage.getItem(LS_PARENT_EMAIL);
  if(!email) email = normalizeEmail(prompt("Confirm your email to finish login:") || "");
  if(!email) return setStatus("Email is required to finish login.", "err");

  await AUTH.signInWithEmailLink(email, window.location.href);
  localStorage.removeItem(LS_PARENT_EMAIL);

  // clean URL
  window.history.replaceState({}, document.title, location.pathname);
}

/* ================= Auth state router ================= */
async function authStateReady(user){
  APP.user = user || null;

  if(!APP.user){
    APP.role = null;
    stopListeners();
    showRolePick();
    return;
  }

  // Ensure school code present (from URL param or saved)
  const saved = localStorage.getItem(LS_SCHOOL) || "";
  if(!APP.schoolCode && saved) setSchoolCode(saved);

  if(!APP.schoolCode){
    await AUTH.signOut();
    showRolePick();
    return setStatus("Missing school code.", "err");
  }

  // Staff vs Parent: staff must be allow-listed
  try{
    const staffOk = await isStaffAllowListed(APP.user.uid);
    if(staffOk){
      APP.role = "staff";
      showStaff();
      bindSchoolDataForStaff();
      setStatus("Staff signed in.", "ok");
      return;
    }
    // Not allow-listed => parent
    APP.role = "parent";
    showParent();
    renderParentHeader();
    bindSchoolDataForParent();
    setStatus("Parent signed in.", "ok");
  } catch(e){
    console.error(e);
    await AUTH.signOut();
    showRolePick();
    setStatus("Access check failed. Verify rules and allow-list.", "err");
  }
}

/* ================= Events ================= */
logoutBtn.addEventListener("click", async ()=>{
  await AUTH.signOut();
  setStatus("Logged out.", "info");
});

pickStaffBtn.addEventListener("click", showStaffAuth);
pickParentBtn.addEventListener("click", showParentAuth);
backToRole1.addEventListener("click", showRolePick);
backToRole2.addEventListener("click", showRolePick);

staffCreateBtn.addEventListener("click", async ()=>{
  try{
    const code = (staffSchoolCode.value||"").trim().toUpperCase();
    const email = normalizeEmail(staffEmail.value||"");
    const pass  = (staffPassword.value||"").trim();
    if(!code) return setStatus("Enter school code.", "err");
    if(!email || !pass) return setStatus("Enter email/password.", "err");
    setSchoolCode(code);

    await AUTH.createUserWithEmailAndPassword(email, pass);
    setStatus("Account created. Admin must allow-list your UID.", "ok");
  } catch(e){
    console.error(e);
    setStatus(e?.message || "Error", "err");
  }
});

staffLoginBtn.addEventListener("click", async ()=>{
  try{
    const code = (staffSchoolCode.value||"").trim().toUpperCase();
    const email = normalizeEmail(staffEmail.value||"");
    const pass  = (staffPassword.value||"").trim();
    if(!code) return setStatus("Enter school code.", "err");
    if(!email || !pass) return setStatus("Enter email/password.", "err");
    setSchoolCode(code);

    await AUTH.signInWithEmailAndPassword(email, pass);
  } catch(e){
    console.error(e);
    setStatus(e?.message || "Error", "err");
  }
});

sendEmailLinkBtn.addEventListener("click", async ()=>{
  try { await sendParentEmailLink(); }
  catch(e){ console.error(e); setStatus(e?.message || "Error", "err"); }
});

/* Staff actions */
saveSessionBtn.addEventListener("click", saveSettings);
addGuardianBtn.addEventListener("click", addGuardian);
addChildBtn.addEventListener("click", addChild);
linkBtn.addEventListener("click", linkParentToChild);
exportPdfBtn.addEventListener("click", ()=>exportAndArchive("pdf"));
exportCsvBtn.addEventListener("click", ()=>exportAndArchive("csv"));
clearTodayBtn.addEventListener("click", clearToday);

/* Parent actions */
clearParentSelectionBtn.addEventListener("click", clearParentSelection);
dropOffReqBtn.addEventListener("click", ()=>openParentConfirmModal("DROP_OFF"));
pickUpReqBtn.addEventListener("click", ()=>openParentConfirmModal("PICK_UP"));

pModalCloseBtn.addEventListener("click", closeParentModal);
pModalCancelBtn.addEventListener("click", closeParentModal);
parentConfirmModal.addEventListener("click", (e)=>{ if(e.target===parentConfirmModal) closeParentModal(); });
pModalConfirmBtn.addEventListener("click", commitPending);

/* Staff modal actions */
sModalCloseBtn.addEventListener("click", closeStaffModal);
staffApproveModal.addEventListener("click", (e)=>{ if(e.target===staffApproveModal) closeStaffModal(); });
sModalRejectBtn.addEventListener("click", staffReject);
sModalApproveBtn.addEventListener("click", staffApprove);

/* ================= Boot ================= */
async function boot(){
  updateOfflineUI();

  // read school from URL if present
  const u = new URL(window.location.href);
  const school = (u.searchParams.get("school") || "").trim().toUpperCase();
  if(school) setSchoolCode(school);

  // also restore school from localStorage
  const saved = localStorage.getItem(LS_SCHOOL) || "";
  if(saved){
    staffSchoolCode.value = saved;
    parentSchoolCode.value = saved;
    if(!APP.schoolCode) setSchoolCode(saved);
  }

  showRolePick();

  // If email link opened, finish sign-in first
  try { await completeEmailLinkIfPresent(); }
  catch(e){ console.error(e); setStatus(e?.message || "Error finishing email login", "err"); }

  AUTH.onAuthStateChanged((user)=>authStateReady(user));
}
boot();
</script>
</body>
</html>
